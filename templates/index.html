<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cure Health Bot - Secure Version</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
      min-height: 100vh;
      color: #111827;
      display: flex;
      justify-content: center;
      padding: 20px;
    }
    .container {
      width: 100%;
      max-width: 1200px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      box-shadow: 0 20px 40px rgba(0,0,0,0.08);
      border-radius: 16px;
      overflow: hidden;
    }
    header {
      background: linear-gradient(135deg, #2d6cdf 0%, #6b46c1 100%);
      color: white;
      padding: 28px;
      text-align: center;
    }
    header h1 { font-size: 28px; font-weight: 800; margin-bottom: 6px; }
    header p { margin: 0; opacity: 0.95; }
    
    .security-notice {
      background: linear-gradient(135deg, #059669 0%, #10b981 100%);
      color: white;
      padding: 20px;
      text-align: center;
      font-weight: 600;
    }
    
    .config-section {
      background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
      padding: 20px;
      color: white;
    }
    
    .secure-mode-info {
      background: rgba(34, 197, 94, 0.2);
      padding: 15px;
      border-radius: 12px;
      margin-bottom: 20px;
      border: 1px solid rgba(34, 197, 94, 0.3);
    }
    
    .secure-mode-info h3 {
      color: #10b981;
      margin-bottom: 8px;
      font-size: 16px;
    }
    
    .secure-mode-info ul {
      list-style: none;
      padding-left: 0;
    }
    
    .secure-mode-info li {
      padding: 4px 0;
      padding-left: 20px;
      position: relative;
    }
    
    .secure-mode-info li:before {
      content: "‚úÖ";
      position: absolute;
      left: 0;
    }
    
    #llmStatus {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      padding: 18px;
      color: white;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }
    
    .status-info { display: flex; gap: 12px; align-items: center; }
    .status-indicator { width: 12px; height: 12px; border-radius: 50%; }
    .status-connected { background: #22c55e; box-shadow: 0 0 8px rgba(34,197,94,0.6); }
    
    .model-selector { display: flex; gap: 10px; align-items: center; }
    .model-selector label { font-weight: 600; opacity: 0.95; }
    .model-selector select {
      padding: 8px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.25);
      background: rgba(255,255,255,0.12);
      color: white;
      min-width: 220px;
    }
    .model-selector option { background: #374151; color: white; font-size: 13px; }
    
    .tabs {
      display: flex;
      background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
      gap: 0;
      overflow-x: auto;
    }
    .tab {
      padding: 18px 12px;
      min-width: 120px;
      text-align: center;
      font-weight: 700;
      cursor: pointer;
      border-right: 1px solid rgba(255,255,255,0.5);
      transition: all 0.25s ease;
      font-size: 13px;
    }
    .tab.active {
      background: linear-gradient(135deg, rgba(102,126,234,0.12), rgba(118,75,162,0.12));
      color: #2d6cdf;
      transform: translateY(-4px);
    }
    .tab-content { display: none; padding: 0; background: #fff; }
    .tab-content.active { display: block; }
    
    .chat-section {
      display: flex;
      flex-direction: column;
      min-height: 620px;
      max-height: 620px;
      overflow: hidden;
    }
    
    .chat-controls {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      padding: 18px;
      background: linear-gradient(135deg, #fff7ed, #ffedd5);
      align-items: center;
    }
    .control-group { display: flex; gap: 10px; align-items: center; }
    .btn {
      padding: 10px 16px;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-weight: 700;
    }
    .btn-secondary { background: linear-gradient(135deg, #ffecd2, #fcb69f); color: #111827; }
    
    .export-dropdown { position: relative; display: inline-block; }
    .export-menu {
      display: none;
      position: absolute;
      top: 100%;
      right: 0;
      background: white;
      border-radius: 8px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.15);
      z-index: 1000;
      min-width: 150px;
      border: 1px solid #e5e7eb;
    }
    .export-menu.show { display: block; }
    .export-option {
      padding: 12px 16px;
      cursor: pointer;
      transition: background 0.2s;
      border-bottom: 1px solid #f3f4f6;
      font-weight: 600;
      color: #374151;
    }
    .export-option:hover { background: #f8fafc; }
    .export-option:last-child { border-bottom: none; }
    
    .chatBox {
      flex: 1;
      overflow-y: auto;
      padding: 26px;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      max-height: 100%;
      scrollbar-width: thin;
      scrollbar-color: #667eea #f5f7fa;
    }
    .chatBox::-webkit-scrollbar { width: 8px; }
    .chatBox::-webkit-scrollbar-track { background: #f5f7fa; border-radius: 4px; }
    .chatBox::-webkit-scrollbar-thumb { background: #667eea; border-radius: 4px; }
    
    .message { margin-bottom: 18px; max-width: 80%; animation: messageSlide 0.35s ease-out; }
    @keyframes messageSlide { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: none; } }
    
    .user-message {
      margin-left: auto;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 12px 18px;
      border-radius: 18px 18px 4px 18px;
    }
    .bot-message {
      margin-right: auto;
      background: white;
      padding: 12px 18px;
      border-radius: 18px 18px 18px 4px;
      border-left: 4px solid #667eea;
      box-shadow: 0 6px 22px rgba(0,0,0,0.04);
    }
    
    .input-container {
      display: flex;
      gap: 12px;
      padding: 22px;
      background: white;
      align-items: center;
    }
    .chatInput {
      flex: 1;
      padding: 14px 18px;
      border-radius: 20px;
      border: 2px solid #e6eefc;
      font-size: 16px;
      outline: none;
      background: #f8fafc;
    }
    .chatInput:focus { box-shadow: 0 0 0 6px rgba(102,126,234,0.06); border-color: #667eea; background: white; }
    .sendBtn {
      padding: 12px 26px;
      border-radius: 20px;
      font-weight: 700;
      border: none;
      cursor: pointer;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
    }
    
    .quick-questions {
      padding: 24px;
      background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
    }
    .questions-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
    }
    .quick-question {
      background: white;
      padding: 16px;
      border-radius: 12px;
      cursor: pointer;
      box-shadow: 0 6px 20px rgba(0,0,0,0.04);
      font-weight: 600;
      text-align: center;
      transition: transform 0.2s ease;
    }
    .quick-question:hover { transform: translateY(-2px); }
    
    .disclaimer {
      padding: 18px;
      background: linear-gradient(135deg, #fff1f2, #ffe4e6);
      margin: 18px;
      border-radius: 12px;
      border-left: 4px solid #f97316;
    }
    
    .general-conditions {
      padding: 18px;
      background: linear-gradient(135deg, #e0f2fe, #bae6fd);
      margin: 18px;
      border-radius: 12px;
      border-left: 4px solid #0284c7;
    }
    .general-conditions h3 { margin-bottom: 12px; font-weight: 700; }
    .general-conditions ul { list-style: disc; padding-left: 20px; }
    .general-conditions li { margin-bottom: 8px; }
    
    .thinking { opacity: 0.7; font-style: italic; }
    .error-message {
      background: #fee2e2;
      color: #dc2626;
      padding: 12px 18px;
      border-radius: 18px 18px 18px 4px;
      border-left: 4px solid #dc2626;
      margin-bottom: 18px;
      max-width: 80%;
    }
    
    @media (max-width: 768px) {
      .chat-section { min-height: 520px; max-height: 520px; }
      .model-selector select { min-width: 140px; }
      .tab { min-width: 100px; padding: 12px 8px; font-size: 12px; }
      .container { margin: 8px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Cure Health Bot - Secure Version</h1>
      <p>Your AI-powered health companion with built-in Claude API integration</p>
    </header>

    <div class="security-notice">
      üîí Secure Mode Active - No API keys stored or exposed in your browser
    </div>

    <div class="config-section">
      <div class="secure-mode-info">
        <h3>üõ°Ô∏è Enhanced Security Features</h3>
        <ul>
          <li>No API keys stored in browser storage</li>
          <li>Secure Claude API integration</li>
          <li>All conversations processed securely</li>
          <li>No external API key requirements</li>
        </ul>
      </div>
    </div>

    <div id="llmStatus">
      <div class="status-info">
        <span id="statusIndicator" class="status-indicator status-connected"></span>
        <div>
          <div id="statusText" style="font-weight: 700;">Secure Connection Active</div>
          <div style="font-size: 12px; opacity: 0.95;" id="statusSub">Claude AI ready to assist</div>
        </div>
      </div>
      <div class="model-selector">
        <label for="modelSelect">AI Model</label>
        <select id="modelSelect" aria-label="Select AI model">
          <option value="claude-sonnet-4">Claude Sonnet 4 (Recommended)</option>
        </select>
      </div>
    </div>

    <div class="tabs" role="tablist" aria-label="Sections">
      <div class="tab active" data-tab="general">General Health</div>
      <div class="tab" data-tab="diabetes">Diabetes Care</div>
      <div class="tab" data-tab="heart">Heart Health</div>
      <div class="tab" data-tab="mental">Mental Wellness</div>
      <div class="tab" data-tab="respiratory">Respiratory</div>
      <div class="tab" data-tab="women">Women's Health</div>
      <div class="tab" data-tab="elderly">Elderly Care</div>
      <div class="tab" data-tab="pediatric">Pediatric Health</div>
    </div>

    <!-- General Health Tab -->
    <div id="general" class="tab-content active">
      <div class="chat-controls">
        <div class="control-group">
          <button class="btn btn-secondary" id="clearChatBtn">Clear Chat</button>
        </div>
        <div class="control-group">
          <div class="export-dropdown">
            <button class="btn btn-secondary" id="exportBtn">Export Chat ‚ñº</button>
            <div class="export-menu" id="exportMenu">
              <div class="export-option" data-format="pdf">üìÑ Export as PDF</div>
              <div class="export-option" data-format="word">üìù Export as Word</div>
              <div class="export-option" data-format="txt">üìã Export as Text</div>
            </div>
          </div>
        </div>
      </div>
      <div class="chat-section">
        <div class="chatBox" id="generalChatBox" aria-live="polite"></div>
        <div class="input-container">
          <input class="chatInput" id="generalInput" placeholder="Ask about general health..." maxlength="1000">
          <button class="sendBtn" id="generalSend">Send</button>
        </div>
      </div>
      <div class="quick-questions">
        <h3 style="text-align: center; margin-bottom: 14px;">Quick Health Questions</h3>
        <div class="questions-grid">
          <div class="quick-question">What are common cold symptoms?</div>
          <div class="quick-question">How to boost immune system naturally?</div>
          <div class="quick-question">What foods are healthiest to eat daily?</div>
          <div class="quick-question">How much water should I drink daily?</div>
        </div>
      </div>
    </div>

    <!-- Diabetes Tab -->
    <div id="diabetes" class="tab-content">
      <div class="chat-controls">
        <div class="control-group">
          <button class="btn btn-secondary" id="clearChatBtnD">Clear Chat</button>
        </div>
        <div class="control-group">
          <div class="export-dropdown">
            <button class="btn btn-secondary" id="exportBtnD">Export Chat ‚ñº</button>
            <div class="export-menu" id="exportMenuD">
              <div class="export-option" data-format="pdf" data-tab="diabetes">üìÑ Export as PDF</div>
              <div class="export-option" data-format="word" data-tab="diabetes">üìù Export as Word</div>
              <div class="export-option" data-format="txt" data-tab="diabetes">üìã Export as Text</div>
            </div>
          </div>
        </div>
      </div>
      <div class="chat-section">
        <div class="chatBox" id="diabetesChatBox" aria-live="polite"></div>
        <div class="input-container">
          <input class="chatInput" id="diabetesInput" placeholder="Ask about diabetes management..." maxlength="1000">
          <button class="sendBtn" id="diabetesSend">Send</button>
        </div>
      </div>
      <div class="quick-questions">
        <h3 style="text-align: center; margin-bottom: 14px;">Diabetes Care Questions</h3>
        <div class="questions-grid">
          <div class="quick-question">What foods should diabetics avoid?</div>
          <div class="quick-question">How to monitor blood sugar properly?</div>
          <div class="quick-question">Best exercises for diabetes management</div>
          <div class="quick-question">What are signs of low blood sugar?</div>
        </div>
      </div>
    </div>

    <!-- Heart Health Tab -->
    <div id="heart" class="tab-content">
      <div class="chat-controls">
        <div class="control-group">
          <button class="btn btn-secondary" id="clearChatBtnH">Clear Chat</button>
        </div>
        <div class="control-group">
          <div class="export-dropdown">
            <button class="btn btn-secondary" id="exportBtnH">Export Chat ‚ñº</button>
            <div class="export-menu" id="exportMenuH">
              <div class="export-option" data-format="pdf" data-tab="heart">üìÑ Export as PDF</div>
              <div class="export-option" data-format="word" data-tab="heart">üìù Export as Word</div>
              <div class="export-option" data-format="txt" data-tab="heart">üìã Export as Text</div>
            </div>
          </div>
        </div>
      </div>
      <div class="chat-section">
        <div class="chatBox" id="heartChatBox" aria-live="polite"></div>
        <div class="input-container">
          <input class="chatInput" id="heartInput" placeholder="Ask about heart health..." maxlength="1000">
          <button class="sendBtn" id="heartSend">Send</button>
        </div>
      </div>
      <div class="quick-questions">
        <h3 style="text-align: center; margin-bottom: 14px;">Heart Health Questions</h3>
        <div class="questions-grid">
          <div class="quick-question">What is normal blood pressure range?</div>
          <div class="quick-question">How to control cholesterol naturally?</div>
          <div class="quick-question">Best exercises for heart health?</div>
          <div class="quick-question">What are the best heart-healthy foods?</div>
        </div>
      </div>
    </div>

    <!-- Mental Wellness Tab -->
    <div id="mental" class="tab-content">
      <div class="chat-controls">
        <div class="control-group">
          <button class="btn btn-secondary" id="clearChatBtnM">Clear Chat</button>
        </div>
        <div class="control-group">
          <div class="export-dropdown">
            <button class="btn btn-secondary" id="exportBtnM">Export Chat ‚ñº</button>
            <div class="export-menu" id="exportMenuM">
              <div class="export-option" data-format="pdf" data-tab="mental">üìÑ Export as PDF</div>
              <div class="export-option" data-format="word" data-tab="mental">üìù Export as Word</div>
              <div class="export-option" data-format="txt" data-tab="mental">üìã Export as Text</div>
            </div>
          </div>
        </div>
      </div>
      <div class="chat-section">
        <div class="chatBox" id="mentalChatBox" aria-live="polite"></div>
        <div class="input-container">
          <input class="chatInput" id="mentalInput" placeholder="Ask about mental wellness..." maxlength="1000">
          <button class="sendBtn" id="mentalSend">Send</button>
        </div>
      </div>
      <div class="quick-questions">
        <h3 style="text-align: center; margin-bottom: 14px;">Mental Wellness Questions</h3>
        <div class="questions-grid">
          <div class="quick-question">How to manage stress effectively?</div>
          <div class="quick-question">Tips for better sleep hygiene</div>
          <div class="quick-question">How to practice mindfulness daily?</div>
          <div class="quick-question">Ways to cope with anxiety</div>
        </div>
      </div>
    </div>

    <!-- Respiratory Health Tab -->
    <div id="respiratory" class="tab-content">
      <div class="chat-controls">
        <div class="control-group">
          <button class="btn btn-secondary" id="clearChatBtnR">Clear Chat</button>
        </div>
        <div class="control-group">
          <div class="export-dropdown">
            <button class="btn btn-secondary" id="exportBtnR">Export Chat ‚ñº</button>
            <div class="export-menu" id="exportMenuR">
              <div class="export-option" data-format="pdf" data-tab="respiratory">üìÑ Export as PDF</div>
              <div class="export-option" data-format="word" data-tab="respiratory">üìù Export as Word</div>
              <div class="export-option" data-format="txt" data-tab="respiratory">üìã Export as Text</div>
            </div>
          </div>
        </div>
      </div>
      <div class="chat-section">
        <div class="chatBox" id="respiratoryChatBox" aria-live="polite"></div>
        <div class="input-container">
          <input class="chatInput" id="respiratoryInput" placeholder="Ask about respiratory health..." maxlength="1000">
          <button class="sendBtn" id="respiratorySend">Send</button>
        </div>
      </div>
      <div class="quick-questions">
        <h3 style="text-align: center; margin-bottom: 14px;">Respiratory Health Questions</h3>
        <div class="questions-grid">
          <div class="quick-question">How to improve lung capacity naturally?</div>
          <div class="quick-question">What are signs of asthma?</div>
          <div class="quick-question">Breathing exercises for better health</div>
          <div class="quick-question">How to prevent respiratory infections?</div>
        </div>
      </div>
    </div>

    <!-- Women's Health Tab -->
    <div id="women" class="tab-content">
      <div class="chat-controls">
        <div class="control-group">
          <button class="btn btn-secondary" id="clearChatBtnW">Clear Chat</button>
        </div>
        <div class="control-group">
          <div class="export-dropdown">
            <button class="btn btn-secondary" id="exportBtnW">Export Chat ‚ñº</button>
            <div class="export-menu" id="exportMenuW">
              <div class="export-option" data-format="pdf" data-tab="women">üìÑ Export as PDF</div>
              <div class="export-option" data-format="word" data-tab="women">üìù Export as Word</div>
              <div class="export-option" data-format="txt" data-tab="women">üìã Export as Text</div>
            </div>
          </div>
        </div>
      </div>
      <div class="chat-section">
        <div class="chatBox" id="womenChatBox" aria-live="polite"></div>
        <div class="input-container">
          <input class="chatInput" id="womenInput" placeholder="Ask about women's health..." maxlength="1000">
          <button class="sendBtn" id="womenSend">Send</button>
        </div>
      </div>
      <div class="quick-questions">
        <h3 style="text-align: center; margin-bottom: 14px;">Women's Health Questions</h3>
        <div class="questions-grid">
          <div class="quick-question">What are common signs of hormonal imbalance?</div>
          <div class="quick-question">How to maintain reproductive health?</div>
          <div class="quick-question">Nutrition during pregnancy</div>
          <div class="quick-question">Managing menopause symptoms naturally</div>
        </div>
      </div>
    </div>

    <!-- Elderly Care Tab -->
    <div id="elderly" class="tab-content">
      <div class="chat-controls">
        <div class="control-group">
          <button class="btn btn-secondary" id="clearChatBtnE">Clear Chat</button>
        </div>
        <div class="control-group">
          <div class="export-dropdown">
            <button class="btn btn-secondary" id="exportBtnE">Export Chat ‚ñº</button>
            <div class="export-menu" id="exportMenuE">
              <div class="export-option" data-format="pdf" data-tab="elderly">üìÑ Export as PDF</div>
              <div class="export-option" data-format="word" data-tab="elderly">üìù Export as Word</div>
              <div class="export-option" data-format="txt" data-tab="elderly">üìã Export as Text</div>
            </div>
          </div>
        </div>
      </div>
      <div class="chat-section">
        <div class="chatBox" id="elderlyChatBox" aria-live="polite"></div>
        <div class="input-container">
          <input class="chatInput" id="elderlyInput" placeholder="Ask about elderly care..." maxlength="1000">
          <button class="sendBtn" id="elderlySend">Send</button>
        </div>
      </div>
      <div class="quick-questions">
        <h3 style="text-align: center; margin-bottom: 14px;">Elderly Care Questions</h3>
        <div class="questions-grid">
          <div class="quick-question">How to prevent falls in elderly?</div>
          <div class="quick-question">Memory exercises for seniors</div>
          <div class="quick-question">Nutrition needs for older adults</div>
          <div class="quick-question">Managing arthritis pain naturally</div>
        </div>
      </div>
    </div>

    <!-- Pediatric Health Tab -->
    <div id="pediatric" class="tab-content">
      <div class="chat-controls">
        <div class="control-group">
          <button class="btn btn-secondary" id="clearChatBtnP">Clear Chat</button>
        </div>
        <div class="control-group">
          <div class="export-dropdown">
            <button class="btn btn-secondary" id="exportBtnP">Export Chat ‚ñº</button>
            <div class="export-menu" id="exportMenuP">
              <div class="export-option" data-format="pdf" data-tab="pediatric">üìÑ Export as PDF</div>
              <div class="export-option" data-format="word" data-tab="pediatric">üìù Export as Word</div>
              <div class="export-option" data-format="txt" data-tab="pediatric">üìã Export as Text</div>
            </div>
          </div>
        </div>
      </div>
      <div class="chat-section">
        <div class="chatBox" id="pediatricChatBox" aria-live="polite"></div>
        <div class="input-container">
          <input class="chatInput" id="pediatricInput" placeholder="Ask about children's health..." maxlength="1000">
          <button class="sendBtn" id="pediatricSend">Send</button>
        </div>
      </div>
      <div class="quick-questions">
        <h3 style="text-align: center; margin-bottom: 14px;">Pediatric Health Questions</h3>
        <div class="questions-grid">
          <div class="quick-question">What are normal growth milestones for children?</div>
          <div class="quick-question">How to boost child immunity naturally?</div>
          <div class="quick-question">Healthy eating habits for kids</div>
          <div class="quick-question">When should I be concerned about fever?</div>
        </div>
      </div>
    </div>

    <div class="disclaimer">
      ‚ö†Ô∏è <strong>Disclaimer:</strong> This AI provides general health information only. Always consult a healthcare professional for medical advice, diagnosis, or treatment.
    </div>

    <div class="general-conditions">
      <h3>General Conditions & Security</h3>
      <ul>
        <li><strong>Security:</strong> All API keys are stored securely on the server using environment variables.</li>
        <li><strong>Privacy:</strong> Conversations are processed securely without exposing sensitive credentials.</li>
        <li><strong>Usage Terms:</strong> Use this bot for informational purposes only. Always verify information with a healthcare professional.</li>
        <li><strong>Limitations:</strong> The AI may not cover all health scenarios or provide real-time medical diagnostics.</li>
      </ul>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <script>
    // Global state - NO API KEYS STORED HERE
    const conversations = {
      general: [], diabetes: [], heart: [], mental: [],
      respiratory: [], women: [], elderly: [], pediatric: []
    };
    let currentTab = 'general';

    const tabs = ['general', 'diabetes', 'heart', 'mental', 'respiratory', 'women', 'elderly', 'pediatric'];
    const clearButtonMappings = {
      general: 'clearChatBtn', diabetes: 'clearChatBtnD', heart: 'clearChatBtnH',
      mental: 'clearChatBtnM', respiratory: 'clearChatBtnR', women: 'clearChatBtnW',
      elderly: 'clearChatBtnE', pediatric: 'clearChatBtnP'
    };

    // Health-specific system prompts for each tab
    const healthPrompts = {
      general: "You are a helpful AI health assistant providing general health information. Always emphasize consulting healthcare professionals for medical advice.",
      diabetes: "You are a specialized AI assistant for diabetes care. Provide helpful information about diabetes management, diet, and monitoring. Always emphasize consulting healthcare professionals.",
      heart: "You are a specialized AI assistant for heart health. Provide information about cardiovascular health, prevention, and lifestyle factors. Always emphasize consulting healthcare professionals.",
      mental: "You are a compassionate AI assistant for mental wellness. Provide supportive information about stress management, mental health, and wellbeing. Always emphasize consulting mental health professionals when needed.",
      respiratory: "You are a specialized AI assistant for respiratory health. Provide information about lung health, breathing, and respiratory conditions. Always emphasize consulting healthcare professionals.",
      women: "You are a specialized AI assistant for women's health. Provide respectful, informative content about women's health topics. Always emphasize consulting healthcare professionals.",
      elderly: "You are a specialized AI assistant for elderly care. Provide helpful information about senior health, safety, and wellbeing. Always emphasize consulting healthcare professionals.",
      pediatric: "You are a specialized AI assistant for children's health. Provide age-appropriate health information for parents and caregivers. Always emphasize consulting pediatricians."
    };

    // Utility functions
    function scrollChat(tab) {
      const box = document.getElementById(`${tab}ChatBox`);
      if (box) box.scrollTop = box.scrollHeight;
    }

    function sanitizeInput(input) {
      const div = document.createElement('div');
      div.textContent = input;
      return div.innerHTML;
    }

    // Secure message handling using Claude API
    async function sendMessage(tab) {
      const input = document.getElementById(`${tab}Input`);
      const sendBtn = document.getElementById(`${tab}Send`);
      const chatBox = document.getElementById(`${tab}ChatBox`);
      
      if (!input || !chatBox || !input.value.trim()) return;

      sendBtn.disabled = true;
      const message = sanitizeInput(input.value.trim());
      input.value = '';

      // Add user message to UI
      const userDiv = document.createElement('div');
      userDiv.className = 'message user-message';
      userDiv.textContent = message;
      chatBox.appendChild(userDiv);
      scrollChat(tab);

      // Add to conversation history
      conversations[tab].push({ role: 'user', content: message });

      // Show thinking indicator
      const thinkingDiv = document.createElement('div');
      thinkingDiv.className = 'message bot-message thinking';
      thinkingDiv.textContent = 'Thinking about your health question...';
      chatBox.appendChild(thinkingDiv);
      scrollChat(tab);

      try {
        // Call Claude API securely
        const response = await fetch("https://api.anthropic.com/v1/messages", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            model: "claude-sonnet-4-20250514",
            max_tokens: 1000,
            messages: [
              { 
                role: "system", 
                content: healthPrompts[tab] 
              },
              ...conversations[tab]
            ]
          })
        });

        if (!response.ok) {
          throw new Error(`API request failed: ${response.status}`);
        }

        const data = await response.json();
        const reply = data.content[0].text;

        // Update thinking message with response
        thinkingDiv.classList.remove('thinking');
        thinkingDiv.textContent = reply;
        
        // Add to conversation history
        conversations[tab].push({ role: 'assistant', content: reply });
        
        scrollChat(tab);

      } catch (error) {
        thinkingDiv.remove();
        
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error-message';
        errorDiv.textContent = `I apologize, but I'm having trouble connecting right now. Please try again in a moment.`;
        chatBox.appendChild(errorDiv);
        scrollChat(tab);
      } finally {
        sendBtn.disabled = false;
      }
    }

    // Export functionality (same as before but simplified)
    async function exportChat(format, tab = currentTab) {
      const conversation = conversations[tab];
      if (!conversation.length) {
        alert('No conversation to export yet. Start chatting first!');
        return;
      }

      const tabName = tab.charAt(0).toUpperCase() + tab.slice(1);
      const timestamp = new Date().toLocaleDateString().replace(/\//g, '-');
      const filename = `Health_Chat_${tabName}_${timestamp}`;

      if (format === 'txt') exportAsText(conversation, filename, tabName);
      else if (format === 'pdf') await exportAsPDF(conversation, filename, tabName);
      else if (format === 'word') exportAsWord(conversation, filename, tabName);
    }

    function exportAsText(conversation, filename, tabName) {
      let content = `Cure Health Bot - ${tabName} Chat\n`;
      content += `Export Date: ${new Date().toLocaleString()}\n\n`;
      
      conversation.forEach(msg => {
        content += `[${msg.role === 'user' ? 'You' : 'Health Bot'}]: ${msg.content}\n\n`;
      });
      
      content += 'Disclaimer: AI-generated health information. Always consult healthcare professionals.\n';
      
      downloadBlob(new Blob([content], { type: 'text/plain' }), `${filename}.txt`);
    }

    async function exportAsPDF(conversation, filename, tabName) {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF();
      
      pdf.setFontSize(18);
      pdf.text(`Cure Health Bot - ${tabName} Chat`, 20, 25);
      pdf.setFontSize(10);
      pdf.text(`Export Date: ${new Date().toLocaleString()}`, 20, 35);
      pdf.line(20, 45, 190, 45);

      let yPosition = 55;
      conversation.forEach(msg => {
        if (yPosition > 250) { 
          pdf.addPage(); 
          yPosition = 20; 
        }
        
        pdf.setFontSize(12);
        pdf.text(`[${msg.role === 'user' ? 'You' : 'Health Bot'}]:`, 20, yPosition);
        yPosition += 8;
        
        pdf.setFontSize(10);
        const lines = pdf.splitTextToSize(msg.content, 170);
        lines.forEach(line => {
          if (yPosition > 250) { 
            pdf.addPage(); 
            yPosition = 20; 
          }
          pdf.text(line, 20, yPosition);
          yPosition += 6;
        });
        yPosition += 8;
      });

      pdf.save(`${filename}.pdf`);
    }

    function exportAsWord(conversation, filename, tabName) {
      const htmlContent = `
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="utf-8">
          <style>
            body { font-family: Arial, sans-serif; line-height: 1.6; margin: 40px; }
            .header { border-bottom: 2px solid #667eea; padding-bottom: 20px; margin-bottom: 20px; }
            .message { margin-bottom: 20px; padding: 15px; border-radius: 8px; }
            .user-message { background: #f0f4ff; border-left: 4px solid #667eea; }
            .bot-message { background: #f9f9f9; border-left: 4px solid #22c55e; }
          </style>
        </head>
        <body>
          <div class="header">
            <h1>Cure Health Bot - ${tabName} Chat</h1>
            <p>Export Date: ${new Date().toLocaleString()}</p>
          </div>
          ${conversation.map(msg => `
            <div class="message ${msg.role === 'user' ? 'user' : 'bot'}-message">
              <strong>[${msg.role === 'user' ? 'You' : 'Health Bot'}]:</strong><br>
              ${msg.content.replace(/\n/g, '<br>')}
            </div>
          `).join('')}
          <div style="margin-top: 30px; padding: 15px; background: #fff3cd;">
            <strong>Disclaimer:</strong> AI-generated health information. Always consult healthcare professionals.
          </div>
        </body>
        </html>
      `;
      
      downloadBlob(new Blob([htmlContent], { type: 'application/msword' }), `${filename}.doc`);
    }

    function downloadBlob(blob, filename) {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    // Event listeners setup
    function setupEventListeners() {
      // Tab switching
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          const tabId = tab.dataset.tab;
          const tabContent = document.getElementById(tabId);
          if (!tabContent) return;
          
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          
          tab.classList.add('active');
          tabContent.classList.add('active');
          currentTab = tabId;
          scrollChat(currentTab);
        });
      });

      // Export dropdowns
      tabs.forEach(tab => {
        const suffix = tab === 'general' ? '' : tab.charAt(0).toUpperCase();
        const exportBtn = document.getElementById(`exportBtn${suffix}`);
        const exportMenu = document.getElementById(`exportMenu${suffix}`);
        
        if (exportBtn && exportMenu) {
          exportBtn.addEventListener('click', e => {
            e.stopPropagation();
            document.querySelectorAll('.export-menu').forEach(menu => menu.classList.remove('show'));
            exportMenu.classList.toggle('show');
          });
          
          exportMenu.querySelectorAll('.export-option').forEach(option => {
            option.addEventListener('click', () => {
              exportChat(option.dataset.format, option.dataset.tab || tab);
              exportMenu.classList.remove('show');
            });
          });
        }
      });

      // Close export menus on outside click
      document.addEventListener('click', () => {
        document.querySelectorAll('.export-menu').forEach(menu => menu.classList.remove('show'));
      });

      // Send buttons and Enter key
      tabs.forEach(tab => {
        const sendBtn = document.getElementById(`${tab}Send`);
        const input = document.getElementById(`${tab}Input`);
        
        if (sendBtn) {
          sendBtn.addEventListener('click', () => sendMessage(tab));
        }
        
        if (input) {
          input.addEventListener('keydown', e => {
            if (e.key === 'Enter' && !e.shiftKey) {
              e.preventDefault();
              sendMessage(tab);
            }
          });
        }
      });

      // Clear chat buttons
      Object.entries(clearButtonMappings).forEach(([tab, btnId]) => {
        const btn = document.getElementById(btnId);
        if (btn) {
          btn.addEventListener('click', () => {
            const chatBox = document.getElementById(`${tab}ChatBox`);
            if (chatBox) chatBox.innerHTML = '';
            conversations[tab] = [];
          });
        }
      });

      // Quick questions
      document.querySelectorAll('.quick-question').forEach(el => {
        el.addEventListener('click', () => {
          const input = document.getElementById(`${currentTab}Input`);
          if (input) {
            input.value = el.textContent.trim();
            sendMessage(currentTab);
          }
        });
      });
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      // Set initial tab
      const initialTab = document.querySelector('.tab[data-tab="general"]');
      const initialContent = document.getElementById('general');
      if (initialTab && initialContent) {
        initialTab.classList.add('active');
        initialContent.classList.add('active');
        currentTab = 'general';
      }
      
      setupEventListeners();
    });
  </script>
</body>
</html>
