<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Cure Health Bot</title>
  <script src="https://unpkg.com/jspdf@latest/dist/jspdf.umd.min.js" defer></script>
  <style>
    /* CSS Reset */
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      /* Modern Dark Theme Colors */
      --primary: #6366f1; /* Indigo */
      --primary-dark: #4f46e5;
      --primary-light: #8b5cf6;
      --secondary: #10b981; /* Emerald */
      --accent: #f59e0b; /* Amber */
      --background: #0f172a; /* Slate 900 */
      --surface: #1e293b; /* Slate 800 */
      --surface-light: #334155; /* Slate 700 */
      --text: #f8fafc; /* Slate 50 */
      --text-muted: #94a3b8; /* Slate 400 */
      --error: #ef4444; /* Red 500 */
      --success: #22c55e; /* Green 500 */
      --warning: #f59e0b; /* Amber 500 */
      --border: #475569; /* Slate 600 */
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --gradient: linear-gradient(135deg, #6366f1, #8b5cf6, #10b981);
      --gradient-secondary: linear-gradient(135deg, #1e293b, #334155);
      --glass: backdrop-filter: blur(10px) saturate(180%);
      --glow: 0 0 20px rgba(99, 102, 241, 0.3);
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
      min-height: 100vh;
      color: var(--text);
      display: flex;
      justify-content: center;
      padding: 8px;
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
      position: relative;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle at 50% 50%, rgba(99, 102, 241, 0.1) 0%, transparent 70%);
      pointer-events: none;
      z-index: -1;
    }

    .loading-spinner {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(15, 23, 42, 0.9);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      backdrop-filter: blur(10px);
    }
    .spinner {
      border: 4px solid rgba(99, 102, 241, 0.2);
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .container {
      width: 100%;
      max-width: 900px;
      background: rgba(30, 41, 59, 0.8);
      border-radius: 20px;
      box-shadow: var(--shadow-lg);
      overflow: visible;
      animation: fadeIn 0.6s ease-out forwards;
      backdrop-filter: blur(20px);
      border: 1px solid rgba(99, 102, 241, 0.2);
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    header {
      background: var(--gradient);
      color: var(--text);
      padding: 20px;
      text-align: center;
      border-radius: 20px 20px 0 0;
      position: relative;
      overflow: hidden;
    }

    header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.1) 50%, transparent 70%);
      animation: shimmer 3s ease-in-out infinite;
    }

    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    header h1 {
      font-size: clamp(18px, 5vw, 24px);
      font-weight: 800;
      margin-bottom: 8px;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      position: relative;
      z-index: 1;
    }
    header p {
      margin: 0;
      opacity: 0.9;
      font-size: clamp(12px, 3vw, 14px);
      position: relative;
      z-index: 1;
    }

    .config-section {
      background: var(--surface);
      padding: 16px;
      border-bottom: 1px solid var(--border);
    }
    .config-grid {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 12px;
    }
    .config-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .config-group label {
      font-weight: 600;
      font-size: 13px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .config-group input, .config-group select {
      padding: 12px 16px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--surface-light);
      color: var(--text);
      font-size: 14px;
      width: 100%;
      min-height: 48px;
      transition: all 0.3s ease;
    }
    .config-group input:focus, .config-group select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
      transform: translateY(-1px);
    }
    .config-group input::placeholder {
      color: var(--text-muted);
    }

    .provider-tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 16px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: thin;
      scrollbar-color: var(--primary) transparent;
    }
    .provider-tabs::-webkit-scrollbar {
      height: 4px;
    }
    .provider-tabs::-webkit-scrollbar-track {
      background: transparent;
    }
    .provider-tabs::-webkit-scrollbar-thumb {
      background: var(--primary);
      border-radius: 2px;
    }
    .provider-tab {
      padding: 12px 20px;
      background: var(--surface-light);
      border: 1px solid var(--border);
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.3s ease;
      white-space: nowrap;
      touch-action: manipulation;
      font-size: 14px;
      font-weight: 600;
      border-radius: 12px;
      min-height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .provider-tab.active {
      background: var(--gradient);
      color: var(--text);
      transform: translateY(-2px);
      box-shadow: var(--glow);
    }

    #llmStatus {
      background: var(--gradient-secondary);
      padding: 16px;
      color: var(--text);
      display: flex;
      flex-direction: column;
      gap: 12px;
      border-bottom: 1px solid var(--border);
    }
    .status-info {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }
    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
      position: relative;
    }
    .status-indicator::before {
      content: '';
      position: absolute;
      inset: -4px;
      border-radius: 50%;
      opacity: 0.3;
      animation: pulse 2s infinite;
    }
    .status-loading {
      background: var(--warning);
    }
    .status-loading::before {
      background: var(--warning);
    }
    .status-connected {
      background: var(--success);
    }
    .status-connected::before {
      background: var(--success);
    }
    .status-disconnected {
      background: var(--error);
    }
    .status-disconnected::before {
      background: var(--error);
    }
    @keyframes pulse {
      0% { transform: scale(1); opacity: 0.3; }
      50% { transform: scale(1.5); opacity: 0.1; }
      100% { transform: scale(1); opacity: 0.3; }
    }

    .model-selector {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .model-selector label {
      font-weight: 600;
      font-size: 13px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .model-selector select {
      padding: 12px 16px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--surface-light);
      color: var(--text);
      width: 100%;
      font-size: 14px;
      min-height: 48px;
      transition: all 0.3s ease;
    }
    .model-selector select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }
    .model-selector option {
      background: var(--surface);
      color: var(--text);
    }

    .debug-info {
      background: rgba(0, 0, 0, 0.3);
      color: var(--text-muted);
      padding: 12px;
      border-radius: 12px;
      font-family: 'JetBrains Mono', 'Fira Code', Consolas, monospace;
      font-size: 11px;
      max-height: 120px;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: var(--primary) transparent;
      display: none;
      word-break: break-all;
      border: 1px solid var(--border);
    }

    .debug-toggle, .btn-small {
      padding: 10px 16px;
      border-radius: 10px;
      background: var(--primary);
      color: var(--text);
      border: none;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      touch-action: manipulation;
      min-height: 40px;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .debug-toggle:hover, .btn-small:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
      box-shadow: var(--shadow);
    }

    .tabs {
      display: flex;
      background: var(--surface);
      gap: 2px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: thin;
      scrollbar-color: var(--primary) transparent;
      padding: 8px;
    }
    .tabs::-webkit-scrollbar {
      height: 4px;
    }
    .tabs::-webkit-scrollbar-track {
      background: transparent;
    }
    .tabs::-webkit-scrollbar-thumb {
      background: var(--primary);
      border-radius: 2px;
    }
    .tab {
      padding: 12px 16px;
      min-width: 120px;
      text-align: center;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 13px;
      white-space: nowrap;
      touch-action: manipulation;
      color: var(--text-muted);
      background: var(--surface-light);
      border-radius: 10px;
      min-height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid transparent;
    }
    .tab.active {
      background: var(--gradient);
      color: var(--text);
      transform: translateY(-2px);
      box-shadow: var(--glow);
      border-color: rgba(99, 102, 241, 0.3);
    }

    .tab-content {
      display: none;
      background: var(--background);
      overflow: visible;
    }
    .tab-content.active {
      display: block;
    }

    .chat-controls {
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 16px;
      background: var(--surface);
      align-items: stretch;
      border-bottom: 1px solid var(--border);
    }
    .control-group {
      display: flex;
      gap: 12px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .btn {
      padding: 12px 20px;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      background: var(--gradient);
      color: var(--text);
      font-weight: 600;
      touch-action: manipulation;
      font-size: 14px;
      min-height: 48px;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }
    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }
    .btn:hover::before {
      left: 100%;
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }
    .btn-secondary {
      background: linear-gradient(135deg, var(--surface-light), var(--surface));
      border: 1px solid var(--border);
    }

    .export-dropdown {
      position: relative;
      display: inline-block;
      width: 100%;
    }
    .export-menu {
      display: none;
      position: absolute;
      top: 100%;
      right: 0;
      background: var(--surface);
      border-radius: 12px;
      box-shadow: var(--shadow-lg);
      z-index: 1000;
      min-width: 180px;
      border: 1px solid var(--border);
      overflow: hidden;
    }
    .export-menu.show {
      display: block;
      animation: fadeIn 0.2s ease-out;
    }
    .export-option {
      padding: 12px 16px;
      cursor: pointer;
      transition: all 0.2s;
      border-bottom: 1px solid var(--border);
      font-weight: 600;
      color: var(--text);
      touch-action: manipulation;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .export-option:hover {
      background: var(--surface-light);
      transform: translateX(4px);
    }
    .export-option:last-child {
      border-bottom: none;
    }

    .chat-section {
      min-height: 400px;
      display: flex;
      flex-direction: column;
      overflow: visible;
    }
    .chatBox {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 20px;
      background: var(--background);
      scrollbar-width: thin;
      scrollbar-color: var(--primary) transparent;
      -webkit-overflow-scrolling: touch;
    }
    .chatBox::-webkit-scrollbar {
      width: 6px;
    }
    .chatBox::-webkit-scrollbar-track {
      background: transparent;
    }
    .chatBox::-webkit-scrollbar-thumb {
      background: var(--primary);
      border-radius: 3px;
    }

    .message {
      margin-bottom: 16px;
      max-width: 85%;
      animation: messageSlide 0.4s ease-out;
      word-wrap: break-word;
    }
    @keyframes messageSlide {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .user-message {
      margin-left: auto;
      background: var(--gradient);
      color: var(--text);
      padding: 16px 20px;
      border-radius: 20px 20px 8px 20px;
      font-size: 14px;
      box-shadow: var(--shadow);
      position: relative;
    }
    .user-message::before {
      content: '';
      position: absolute;
      bottom: 0;
      right: -8px;
      width: 0;
      height: 0;
      border-left: 8px solid transparent;
      border-top: 8px solid var(--primary-light);
    }
    .bot-message {
      margin-right: auto;
      background: var(--surface);
      padding: 16px 20px;
      border-radius: 20px 20px 20px 8px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      font-size: 14px;
      line-height: 1.6;
      color: var(--text);
      position: relative;
    }
    .bot-message::before {
      content: '';
      position: absolute;
      bottom: 0;
      left: -8px;
      width: 0;
      height: 0;
      border-right: 8px solid transparent;
      border-top: 8px solid var(--surface);
    }

    .input-container {
      display: flex;
      gap: 12px;
      padding: 20px;
      background: var(--surface);
      align-items: center;
      border-top: 1px solid var(--border);
    }
    .chatInput {
      flex: 1;
      padding: 16px 20px;
      border-radius: 25px;
      border: 1px solid var(--border);
      font-size: 14px;
      outline: none;
      background: var(--surface-light);
      color: var(--text);
      min-height: 48px;
      transition: all 0.3s ease;
      resize: none;
    }
    .chatInput:focus {
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
      border-color: var(--primary);
      background: var(--background);
      transform: translateY(-1px);
    }
    .chatInput::placeholder {
      color: var(--text-muted);
    }
    .sendBtn {
      padding: 16px 24px;
      border-radius: 25px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      background: var(--gradient);
      color: var(--text);
      touch-action: manipulation;
      font-size: 14px;
      min-height: 48px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    .sendBtn:hover {
      transform: translateY(-2px);
      box-shadow: var(--glow);
    }
    .sendBtn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }
    .sendBtn:hover::before {
      left: 100%;
    }

    .quick-questions {
      padding: 20px;
      background: var(--surface);
      border-bottom-left-radius: 20px;
      border-bottom-right-radius: 20px;
    }
    .questions-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 12px;
    }
    .quick-question {
      background: var(--surface-light);
      padding: 16px;
      border-radius: 12px;
      cursor: pointer;
      box-shadow: var(--shadow);
      font-weight: 600;
      text-align: center;
      transition: all 0.3s ease;
      touch-action: manipulation;
      font-size: 13px;
      color: var(--text);
      min-height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid var(--border);
      position: relative;
      overflow: hidden;
    }
    .quick-question::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(99, 102, 241, 0.1), transparent);
      transition: left 0.5s;
    }
    .quick-question:hover::before {
      left: 100%;
    }
    .quick-question:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
      border-color: var(--primary);
    }
    .quick-question[aria-disabled="true"] {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .disclaimer {
      padding: 16px 20px;
      margin: 20px;
      border-radius: 12px;
      font-size: 12px;
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(239, 68, 68, 0.05));
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: var(--text);
      backdrop-filter: blur(10px);
    }

    .thinking {
      opacity: 0.7;
      font-style: italic;
    }
    .error-message {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(239, 68, 68, 0.1));
      color: var(--error);
      padding: 16px 20px;
      border-radius: 20px 20px 20px 8px;
      border: 1px solid rgba(239, 68, 68, 0.3);
      margin-bottom: 16px;
      max-width: 85%;
      font-size: 14px;
      backdrop-filter: blur(10px);
    }

    /* Mobile Optimizations */
    @media (max-width: 768px) {
      body { padding: 4px; }
      .container { 
        max-width: 100%; 
        border-radius: 16px; 
        margin: 0;
      }
      header { 
        padding: 16px; 
        border-radius: 16px 16px 0 0;
      }
      .config-section { padding: 12px; }
      .chat-section { min-height: 300px; }
      .chatBox { padding: 16px; }
      .input-container { padding: 12px; gap: 8px; }
      .quick-questions { padding: 12px; }
      .questions-grid { 
        grid-template-columns: 1fr;
        gap: 8px; 
      }
      .tab { 
        padding: 10px 12px; 
        font-size: 12px; 
        min-width: 90px; 
        min-height: 40px; 
      }
      .tabs { padding: 4px; }
      .model-selector select { font-size: 13px; min-height: 44px; }
      #llmStatus { padding: 12px; }
      .status-info { gap: 8px; }
      .chat-controls { padding: 12px; }
      .control-group { flex-direction: column; gap: 8px; }
      .message { max-width: 90%; }
      .btn, .sendBtn, .quick-question, .btn-small { 
        min-height: 44px; 
        font-size: 13px; 
      }
      .chatInput { 
        min-height: 44px; 
        font-size: 13px; 
        padding: 12px 16px;
      }
      .user-message, .bot-message {
        padding: 12px 16px;
        font-size: 13px;
      }
      .quick-question {
        min-height: 50px;
        padding: 12px;
        font-size: 12px;
      }
    }

    @media (max-width: 480px) {
      .chat-section { min-height: 250px; }
      .quick-question { 
        padding: 10px; 
        font-size: 11px; 
        min-height: 44px; 
      }
      .btn, .sendBtn { 
        padding: 10px 16px; 
        font-size: 12px; 
        min-height: 40px; 
      }
      .chatInput { 
        padding: 10px 14px; 
        font-size: 12px; 
        min-height: 40px; 
      }
      header h1 { font-size: 16px; }
      header p { font-size: 11px; }
      .config-group input, .config-group select { 
        font-size: 12px; 
        min-height: 40px; 
        padding: 10px 12px;
      }
      .user-message, .bot-message {
        padding: 10px 14px;
        font-size: 12px;
      }
      .container {
        border-radius: 12px;
      }
      header {
        border-radius: 12px 12px 0 0;
      }
    }

    /* Enhanced animations */
    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-5px); }
    }

    .provider-tab:hover {
      animation: float 2s ease-in-out infinite;
    }

    .tab:hover {
      animation: float 2s ease-in-out infinite;
    }

    /* Improved focus states for accessibility */
    button:focus-visible,
    input:focus-visible,
    select:focus-visible,
    .tab:focus-visible,
    .quick-question:focus-visible {
      outline: 2px solid var(--primary);
      outline-offset: 2px;
    }

    /* Auto-save indicator */
    .config-section::after {
      content: 'Auto-saves configuration ✓';
      position: absolute;
      top: 8px;
      right: 8px;
      font-size: 10px;
      color: var(--success);
      opacity: 0.7;
      font-weight: 500;
    }

    .config-section {
      position: relative;
    }
  </style>
</head>
<body>
  <div class="loading-spinner" id="loadingSpinner">
    <div class="spinner"></div>
  </div>
  <div class="container">
    <header>
      <h1>Cure Health Bot</h1>
      <p>Your AI-powered health companion with 300+ models</p>
    </header>
    <div class="config-section">
      <div class="provider-tabs">
        <div class="provider-tab active" data-provider="openrouter">OpenRouter</div>
        <div class="provider-tab" data-provider="ollama">Ollama</div>
      </div>
      <div id="openrouter-config" class="provider-config">
                  <div class="config-grid">
          <div class="config-group">
            <label for="openrouterKey">OpenRouter API Key</label>
            <input type="password" id="openrouterKey" placeholder="sk-or-v1-...">
          </div>
          <div class="config-group">
            <label for="openrouterUrl">OpenRouter URL</label>
            <input type="text" id="openrouterUrl" value="https://openrouter.ai/api/v1/chat/completions">
          </div>
        </div>
      </div>
      <div id="ollama-config" class="provider-config" style="display: none;">
        <div class="config-grid">
          <div class="config-group">
            <label for="ollamaUrl">Ollama Server URL</label>
            <input type="text" id="ollamaUrl" value="http://localhost:11434/api/chat">
          </div>
          <div class="config-group">
            <label>Connection Status</label>
            <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
              <span id="ollamaStatus">Not connected</span>
              <button class="btn-small" id="testOllamaBtn">Test Connection</button>
            </div>
          </div>
        </div>
      </div>
      <div style="display: flex; gap: 8px; justify-content: flex-end; flex-wrap: wrap;">
        <button class="btn-small" id="loadModelsBtn">Load Models</button>
        <button class="btn-small" id="saveConfigBtn">Save Config</button>
      </div>
    </div>
    <div id="llmStatus">
      <div class="status-info">
        <span id="statusIndicator" class="status-indicator status-disconnected"></span>
        <div>
          <div id="statusText" style="font-weight: 600;">Not Connected</div>
          <div style="font-size: 11px; opacity: 0.95;" id="statusSub">Configure your API settings</div>
        </div>
        <button class="debug-toggle" id="debugToggleBtn">Debug Info</button>
      </div>
      <div class="model-selector">
        <label for="modelSelect">AI Model</label>
        <select id="modelSelect" aria-label="Select AI model">
          <option value="">Configure provider first</option>
        </select>
        <button class="btn-small" id="refreshModelsBtn">Refresh</button>
      </div>
      <div id="debugInfo" class="debug-info">
        <div id="debugLog">Configure your provider to get started...</div>
      </div>
    </div>
    <div class="tabs" role="tablist" aria-label="Sections">
      <div class="tab active" data-tab="general">General Health</div>
      <div class="tab" data-tab="diabetes">Diabetes Care</div>
      <div class="tab" data-tab="heart">Heart Health</div>
      <div class="tab" data-tab="mental">Mental Wellness</div>
      <div class="tab" data-tab="respiratory">Respiratory</div>
      <div class="tab" data-tab="women">Women's Health</div>
      <div class="tab" data-tab="elderly">Elderly Care</div>
      <div class="tab" data-tab="pediatric">Pediatric Health</div>
    </div>
    <div id="general" class="tab-content active">
      <div class="chat-controls">
        <div class="control-group">
          <button class="btn btn-secondary" id="clearChatBtn">Clear Chat</button>
        </div>
        <div class="control-group">
          <div class="export-dropdown">
            <button class="btn btn-secondary" id="exportBtn">Export Chat ▼</button>
            <div class="export-menu" id="exportMenu">
              <div class="export-option" data-format="pdf" data-tab="general">📄 Export as PDF</div>
              <div class="export-option" data-format="word" data-tab="general">📝 Export as Word</div>
              <div class="export-option" data-format="txt" data-tab="general">📋 Export as Text</div>
            </div>
          </div>
        </div>
      </div>
      <div class="chat-section">
        <div class="chatBox" id="generalChatBox" aria-live="polite"></div>
        <div class="input-container">
          <input class="chatInput" id="generalInput" placeholder="Ask about general health..." maxlength="1000">
          <button class="sendBtn" id="generalSend" aria-label="Send message">Send</button>
        </div>
      </div>
      <div class="quick-questions">
        <h3 style="text-align: center; margin-bottom: 16px; font-size: 14px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Quick Health Questions</h3>
        <div class="questions-grid">
          <div class="quick-question" role="button" tabindex="0" aria-label="Ask about common cold symptoms">What are common cold symptoms?</div>
          <div class="quick-question" role="button" tabindex="0" aria-label="Ask how to boost immune system naturally">How to boost immune system naturally?</div>
          <div class="quick-question" role="button" tabindex="0" aria-label="Ask about the healthiest foods to eat daily">What foods are healthiest to eat daily?</div>
          <div class="quick-question" role="button" tabindex="0" aria-label="Ask how much water to drink daily">How much water should I drink daily?</div>
        </div>
      </div>
    </div>
    <div id="diabetes" class="tab-content">
      <div class="chat-controls">
        <div class="control-group">
          <button class="btn btn-secondary" id="clearChatBtnD">Clear Chat</button>
        </div>
        <div class="control-group">
          <div class="export-dropdown">
            <button class="btn btn-secondary" id="exportBtnD">Export Chat ▼</button>
            <div class="export-menu" id="exportMenuD">
              <div class="export-option" data-format="pdf" data-tab="diabetes">📄 Export as PDF</div>
              <div class="export-option" data-format="word" data-tab="diabetes">📝 Export as Word</div>
              <div class="export-option" data-format="txt" data-tab="diabetes">📋 Export as Text</div>
            </div>
          </div>
        </div>
      </div>
      <div class="chat-section">
        <div class="chatBox" id="diabetesChatBox" aria-live="polite"></div>
        <div class="input-container">
          <input class="chatInput" id="diabetesInput" placeholder="Ask about diabetes management..." maxlength="1000">
          <button class="sendBtn" id="diabetesSend" aria-label="Send message">Send</button>
        </div>
      </div>
      <div class="quick-questions">
        <h3 style="text-align: center; margin-bottom: 16px; font-size: 14px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Diabetes Care Questions</h3>
        <div class="questions-grid">
          <div class="quick-question" role="button" tabindex="0" aria-label="Ask what foods diabetics should avoid">What foods should diabetics avoid?</div>
          <div class="quick-question" role="button" tabindex="0" aria-label="Ask how to monitor blood sugar properly">How to monitor blood sugar properly?</div>
          <div class="quick-question" role="button" tabindex="0" aria-label="Ask about best exercises for diabetes management">Best exercises for diabetes management</div>
          <div class="quick-question" role="button" tabindex="0" aria-label="Ask about signs of low blood sugar">What are signs of low blood sugar?</div>
        </div>
      </div>
    </div>
    <div id="heart" class="tab-content">
      <div class="chat-controls">
        <div class="control-group">
          <button class="btn btn-secondary" id="clearChatBtnH">Clear Chat</button>
        </div>
        <div class="control-group">
          <div class="export-dropdown">
            <button class="btn btn-secondary" id="exportBtnH">Export Chat ▼</button>
            <div class="export-menu" id="exportMenuH">
              <div class="export-option" data-format="pdf" data-tab="heart">📄 Export as PDF</div>
              <div class="export-option" data-format="word" data-tab="heart">📝 Export as Word</div>
              <div class="export-option" data-format="txt" data-tab="heart">📋 Export as Text</div>
            </div>
          </div>
        </div>
      </div>
      <div class="chat-section">
        <div class="chatBox" id="heartChatBox" aria-live="polite"></div>
        <div class="input-container">
          <input class="chatInput" id="heartInput" placeholder="Ask about heart health..." maxlength="1000">
          <button class="sendBtn" id="heartSend" aria-label="Send message">Send</button>
        </div>
      </div>
      <div class="quick-questions">
        <h3 style="text-align: center; margin-bottom: 16px; font-size: 14px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Heart Health Questions</h3>
        <div class="questions-grid">
          <div class="quick-question" role="button" tabindex="0" aria-label="Ask about normal blood pressure range">What is normal blood pressure range?</div>
          <div class="quick-question" role="button" tabindex="0" aria-label="Ask how to control cholesterol naturally">How to control cholesterol naturally?</div>
          <div class="quick-question" role="button" tabindex="0" aria-label="Ask about best exercises for heart health">What exercises are best for heart health?</div>
          <div class="quick-question" role="button" tabindex="0" aria-label="Ask about best heart-healthy foods">What are the best heart-healthy foods?</div>
        </div>
      </div>
    </div>
    <div id="mental" class="tab-content">
      <div class="chat-controls">
        <div class="control-group">
          <button class="btn btn-secondary" id="clearChatBtnM">Clear Chat</button>
        </div>
        <div class="control-group">
          <div class="export-dropdown">
            <button class="btn btn-secondary" id="exportBtnM">Export Chat ▼</button>
            <div class="export-menu" id="exportMenuM">
              <div class="export-option" data-format="pdf" data-tab="mental">📄 Export as PDF</div>
              <div class="export-option" data-format="word" data-tab="mental">📝 Export as Word</div>
              <div class="export-option" data-format="txt" data-tab="mental">📋 Export as Text</div>
            </div>
          </div>
        </div>
      </div>
      <div class="chat-section">
        <div class="chatBox" id="mentalChatBox" aria-live="polite"></div>
        <div class="input-container">
          <input class="chatInput" id="mentalInput" placeholder="Ask about mental wellness..." maxlength="1000">
          <button class="sendBtn" id="mentalSend" aria-label="Send message">Send</button>
        </div>
      </div>
      <div class="quick-questions">
        <h3 style="text-align: center; margin-bottom: 16px; font-size: 14px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Mental Wellness Questions</h3>
        <div class="questions-grid">
          <div class="quick-question" role="button" tabindex="0" aria-label="Ask how to manage stress effectively">How to manage stress effectively?</div>
          <div class="quick-question" role="button" tabindex="0" aria-label="Ask about tips for better sleep hygiene">Tips for better sleep hygiene</div>
          <div class="quick-question" role="button" tabindex="0" aria-label="Ask how to practice mindfulness daily">How to practice mindfulness daily?</div>
          <div class="quick-question" role="button" tabindex="0" aria-label="Ask about ways to cope with anxiety">Ways to cope with anxiety</div>
        </div>
      </div>
    </div>
    <div id="respiratory" class="tab-content">
      <div class="chat-controls">
        <div class="control-group">
          <button class="btn btn-secondary" id="clearChatBtnR">Clear Chat</button>
        </div>
        <div class="control-group">
          <div class="export-dropdown">
            <button class="btn btn-secondary" id="exportBtnR">Export Chat ▼</button>
            <div class="export-menu" id="exportMenuR">
              <div class="export-option" data-format="pdf" data-tab="respiratory">📄 Export as PDF</div>
              <div class="export-option" data-format="word" data-tab="respiratory">📝 Export as Word</div>
              <div class="export-option" data-format="txt" data-tab="respiratory">📋 Export as Text</div>
            </div>
          </div>
        </div>
      </div>
      <div class="chat-section">
        <div class="chatBox" id="respiratoryChatBox" aria-live="polite"></div>
        <div class="input-container">
          <input class="chatInput" id="respiratoryInput" placeholder="Ask about respiratory health..." maxlength="1000">
          <button class="sendBtn" id="respiratorySend" aria-label="Send message">Send</button>
        </div>
      </div>
      <div class="quick-questions">
        <h3 style="text-align: center; margin-bottom: 16px; font-size: 14px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Respiratory Health Questions</h3>
        <div class="questions-grid">
          <div class="quick-question" role="button" tabindex="0" aria-label="Ask how to improve lung capacity naturally">How to improve lung capacity naturally?</div>
          <div class="quick-question" role="button" tabindex="0" aria-label="Ask about signs of asthma">What are signs of asthma?</div>
          <div class="quick-question" role="button" tabindex="0" aria-label="Ask about breathing exercises for better health">Breathing exercises for better health</div>
          <div class="quick-question" role="button" tabindex="0" aria-label="Ask how to prevent respiratory infections">How to prevent respiratory infections?</div>
        </div>
      </div>
    </div>
    <div id="women" class="tab-content">
      <div class="chat-controls">
        <div class="control-group">
          <button class="btn btn-secondary" id="clearChatBtnW">Clear Chat</button>
        </div>
        <div class="control-group">
          <div class="export-dropdown">
            <button class="btn btn-secondary" id="exportBtnW">Export Chat ▼</button>
            <div class="export-menu" id="exportMenuW">
              <div class="export-option" data-format="pdf" data-tab="women">📄 Export as PDF</div>
              <div class="export-option" data-format="word" data-tab="women">📝 Export as Word</div>
              <div class="export-option" data-format="txt" data-tab="women">📋 Export as Text</div>
            </div>
          </div>
        </div>
      </div>
      <div class="chat-section">
        <div class="chatBox" id="womenChatBox" aria-live="polite"></div>
        <div class="input-container">
          <input class="chatInput" id="womenInput" placeholder="Ask about women's health..." maxlength="1000">
          <button class="sendBtn" id="womenSend" aria-label="Send message">Send</button>
        </div>
      </div>
      <div class="quick-questions">
        <h3 style="text-align: center; margin-bottom: 16px; font-size: 14px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Women's Health Questions</h3>
        <div class="questions-grid">
          <div class="quick-question" role="button" tabindex="0" aria-label="Ask about common signs of hormonal imbalance">What are common signs of hormonal imbalance?</div>
          <div class="quick-question" role="button" tabindex="0" aria-label="Ask how to maintain reproductive health">How to maintain reproductive health?</div>
          <div class="quick-question" role="button" tabindex="0" aria-label="Ask about nutrition during pregnancy">Nutrition during pregnancy</div>
          <div class="quick-question" role="button" tabindex="0" aria-label="Ask about managing menopause symptoms naturally">Managing menopause symptoms naturally</div>
        </div>
      </div>
    </div>
    <div id="elderly" class="tab-content">
      <div class="chat-controls">
        <div class="control-group">
          <button class="btn btn-secondary" id="clearChatBtnE">Clear Chat</button>
        </div>
        <div class="control-group">
          <div class="export-dropdown">
            <button class="btn btn-secondary" id="exportBtnE">Export Chat ▼</button>
            <div class="export-menu" id="exportMenuE">
              <div class="export-option" data-format="pdf" data-tab="elderly">📄 Export as PDF</div>
              <div class="export-option" data-format="word" data-tab="elderly">📝 Export as Word</div>
              <div class="export-option" data-format="txt" data-tab="elderly">📋 Export as Text</div>
            </div>
          </div>
        </div>
      </div>
      <div class="chat-section">
        <div class="chatBox" id="elderlyChatBox" aria-live="polite"></div>
        <div class="input-container">
          <input class="chatInput" id="elderlyInput" placeholder="Ask about elderly care..." maxlength="1000">
          <button class="sendBtn" id="elderlySend" aria-label="Send message">Send</button>
        </div>
      </div>
      <div class="quick-questions">
        <h3 style="text-align: center; margin-bottom: 16px; font-size: 14px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Elderly Care Questions</h3>
        <div class="questions-grid">
          <div class="quick-question" role="button" tabindex="0" aria-label="Ask how to prevent falls in elderly">How to prevent falls in elderly?</div>
          <div class="quick-question" role="button" tabindex="0" aria-label="Ask about managing multiple medications safely">Managing multiple medications safely</div>
          <div class="quick-question" role="button" tabindex="0" aria-label="Ask about maintaining cognitive health with age">Maintaining cognitive health with age</div>
          <div class="quick-question" role="button" tabindex="0" aria-label="Ask about nutrition needs for seniors">Nutrition needs for seniors</div>
        </div>
      </div>
    </div>
    <div id="pediatric" class="tab-content">
      <div class="chat-controls">
        <div class="control-group">
          <button class="btn btn-secondary" id="clearChatBtnP">Clear Chat</button>
        </div>
        <div class="control-group">
          <div class="export-dropdown">
            <button class="btn btn-secondary" id="exportBtnP">Export Chat ▼</button>
            <div class="export-menu" id="exportMenuP">
              <div class="export-option" data-format="pdf" data-tab="pediatric">📄 Export as PDF</div>
              <div class="export-option" data-format="word" data-tab="pediatric">📝 Export as Word</div>
              <div class="export-option" data-format="txt" data-tab="pediatric">📋 Export as Text</div>
            </div>
          </div>
        </div>
      </div>
      <div class="chat-section">
        <div class="chatBox" id="pediatricChatBox" aria-live="polite"></div>
        <div class="input-container">
          <input class="chatInput" id="pediatricInput" placeholder="Ask about pediatric health..." maxlength="1000">
          <button class="sendBtn" id="pediatricSend" aria-label="Send message">Send</button>
        </div>
      </div>
      <div class="quick-questions">
        <h3 style="text-align: center; margin-bottom: 16px; font-size: 14px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Pediatric Health Questions</h3>
        <div class="questions-grid">
          <div class="quick-question" role="button" tabindex="0" aria-label="Ask about vaccination schedule for children">Vaccination schedule for children</div>
          <div class="quick-question" role="button" tabindex="0" aria-label="Ask about managing childhood obesity">Managing childhood obesity</div>
          <div class="quick-question" role="button" tabindex="0" aria-label="Ask when to be concerned about fever">When to be concerned about fever?</div>
          <div class="quick-question" role="button" tabindex="0" aria-label="Ask about healthy eating habits for kids">Healthy eating habits for kids</div>
        </div>
      </div>
    </div>
    <div class="disclaimer">
      <strong>⚠️ Medical Disclaimer:</strong> This bot provides general health information only and should not replace professional medical advice. Always consult with healthcare professionals for medical concerns.
    </div>
  </div>
  <script>
    let currentProvider = 'openrouter';
    let conversationHistories = {};
    let isStreaming = false;
    const tabs = ['general', 'diabetes', 'heart', 'mental', 'respiratory', 'women', 'elderly', 'pediatric'];
    tabs.forEach(tab => {
      conversationHistories[tab] = [];
    });

    function addDebugLog(message) {
      const debugLog = document.getElementById('debugLog');
      if (debugLog) {
        const timestamp = new Date().toLocaleTimeString();
        const protocol = window.location.protocol;
        const userAgent = navigator.userAgent;
        debugLog.innerHTML += `[${timestamp}] ${message} (Protocol: ${protocol}, UA: ${userAgent})<br>`;
        debugLog.scrollTop = debugLog.scrollHeight;
        console.log(`[CureBot Debug] ${message} (Protocol: ${protocol}, UA: ${userAgent})`);
      }
    }

    function updateConnectionStatus(status, message, subMessage = '') {
      const indicator = document.getElementById('statusIndicator');
      const text = document.getElementById('statusText');
      const sub = document.getElementById('statusSub');
      if (indicator && text && sub) {
        indicator.className = `status-indicator status-${status}`;
        text.textContent = message;
        sub.textContent = subMessage;
        addDebugLog(`Status: ${status} - ${message}`);
      }
    }

    // Enhanced storage with multiple fallbacks and auto-save
    function setStorageItem(name, value, days = 90) {
      const data = {
        value: value,
        timestamp: Date.now(),
        expires: Date.now() + (days * 24 * 60 * 60 * 1000)
      };
      const serializedData = JSON.stringify(data);
      
      // Try multiple storage methods
      try {
        // Primary: localStorage
        if (typeof Storage !== "undefined") {
          localStorage.setItem(name, serializedData);
          addDebugLog(`Saved to localStorage: ${name}`);
        }
        
        // Secondary: sessionStorage
        if (typeof sessionStorage !== "undefined") {
          sessionStorage.setItem(name + '_session', serializedData);
          addDebugLog(`Saved to sessionStorage: ${name}`);
        }
        
        // Tertiary: cookies (with longer expiration)
        if (days && typeof document !== "undefined") {
          const expires = new Date();
          expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));
          document.cookie = `${name}=${encodeURIComponent(serializedData)}; expires=${expires.toUTCString()}; path=/; SameSite=Lax; Secure`;
          addDebugLog(`Saved to cookies: ${name}`);
        }
        
        return true;
      } catch (error) {
        addDebugLog(`Storage error: ${error.message}`);
        return false;
      }
    }

    function getStorageItem(name) {
      try {
        let data = null;
        
        // Try localStorage first
        if (typeof Storage !== "undefined") {
          const stored = localStorage.getItem(name);
          if (stored) {
            data = JSON.parse(stored);
            addDebugLog(`Retrieved from localStorage: ${name}`);
          }
        }
        
        // Fallback to sessionStorage
        if (!data && typeof sessionStorage !== "undefined") {
          const stored = sessionStorage.getItem(name + '_session');
          if (stored) {
            data = JSON.parse(stored);
            addDebugLog(`Retrieved from sessionStorage: ${name}`);
          }
        }
        
        // Fallback to cookies
        if (!data && typeof document !== "undefined") {
          const nameEQ = name + "=";
          const ca = document.cookie.split(';');
          for (let c of ca) {
            c = c.trim();
            if (c.indexOf(nameEQ) === 0) {
              const cookieData = decodeURIComponent(c.substring(nameEQ.length));
              data = JSON.parse(cookieData);
              addDebugLog(`Retrieved from cookies: ${name}`);
              break;
            }
          }
        }
        
        // Check if data has expired
        if (data && data.expires && Date.now() > data.expires) {
          addDebugLog(`Data expired for: ${name}`);
          return null;
        }
        
        return data ? data.value : null;
      } catch (error) {
        addDebugLog(`Storage retrieval error: ${error.message}`);
        return null;
      }
    }

    // Auto-save configuration on any input change
    function autoSaveConfig() {
      try {
        const openrouterKey = document.getElementById('openrouterKey')?.value?.trim();
        if (!openrouterKey) return; // Don't save empty config
        
        const config = {
          provider: currentProvider,
          openrouter: {
            key: openrouterKey,
            url: document.getElementById('openrouterUrl')?.value?.trim() || 'https://openrouter.ai/api/v1/chat/completions'
          },
          ollama: {
            url: document.getElementById('ollamaUrl')?.value?.trim() || 'http://localhost:11434/api/chat'
          },
          selectedModel: document.getElementById('modelSelect')?.value || '',
          lastSaved: Date.now()
        };
        
        const saved = setStorageItem('curebotConfig', config, 90);
        if (saved) {
          addDebugLog(`Auto-saved configuration: API key (${openrouterKey.slice(0, 4)}...)`);
          // Visual feedback
          showAutoSaveIndicator();
        }
      } catch (error) {
        addDebugLog(`Auto-save failed: ${error.message}`);
      }
    }

    function showAutoSaveIndicator() {
      // Create or update auto-save indicator
      let indicator = document.getElementById('autoSaveIndicator');
      if (!indicator) {
        indicator = document.createElement('div');
        indicator.id = 'autoSaveIndicator';
        indicator.style.cssText = `
          position: fixed; 
          top: 20px; 
          right: 20px; 
          background: var(--success); 
          color: white; 
          padding: 8px 12px; 
          border-radius: 20px; 
          font-size: 12px; 
          z-index: 1000; 
          opacity: 0; 
          transition: opacity 0.3s ease;
          pointer-events: none;
        `;
        document.body.appendChild(indicator);
      }
      
      indicator.textContent = '✓ Auto-saved';
      indicator.style.opacity = '1';
      
      setTimeout(() => {
        indicator.style.opacity = '0';
      }, 2000);
    }

    function saveConfig() {
      autoSaveConfig();
      alert('Configuration saved successfully!');
    }

    function loadConfig() {
      try {
        const saved = getStorageItem('curebotConfig');
        if (!saved) {
          addDebugLog('No configuration found in storage');
          updateConnectionStatus('disconnected', 'No Config Found', 'Please enter and save API settings');
          return;
        }
        
        const config = saved;
        if (!config || typeof config !== 'object') {
          throw new Error('Invalid configuration format');
        }
        
        currentProvider = config.provider || 'openrouter';
        
        // Set up input change listeners before loading values
        setupAutoSaveListeners();
        
        let retries = 0;
        const maxRetries = 15;
        const setInputs = () => {
          const openrouterKeyElement = document.getElementById('openrouterKey');
          if (!openrouterKeyElement && retries < maxRetries) {
            addDebugLog(`OpenRouter key input not ready, retry ${retries + 1}/${maxRetries}`);
            retries++;
            setTimeout(setInputs, 200);
            return;
          }
          
          if (!openrouterKeyElement) {
            throw new Error('OpenRouter key input not found after retries');
          }
          
          // Load configuration values
          openrouterKeyElement.value = config.openrouter?.key || '';
          document.getElementById('openrouterUrl').value = config.openrouter?.url || 'https://openrouter.ai/api/v1/chat/completions';
          document.getElementById('ollamaUrl').value = config.ollama?.url || 'http://localhost:11434/api/chat';
          
          // Update UI
          document.querySelectorAll('.provider-tab').forEach(tab => {
            tab.classList.toggle('active', tab.dataset.provider === currentProvider);
          });
          document.getElementById('openrouter-config').style.display = currentProvider === 'openrouter' ? 'block' : 'none';
          document.getElementById('ollama-config').style.display = currentProvider === 'ollama' ? 'block' : 'none';
          
          if (config.selectedModel) {
            const modelSelect = document.getElementById('modelSelect');
            const optionExists = Array.from(modelSelect.options).some(opt => opt.value === config.selectedModel);
            if (optionExists) {
              modelSelect.value = config.selectedModel;
            }
          }
          
          addDebugLog(`Configuration loaded: API key (${config.openrouter?.key ? config.openrouter.key.slice(0, 4) + '...' : 'none'})`);
          if (config.openrouter?.key) {
            updateConnectionStatus('connected', 'Configuration Loaded', 'API key retrieved from storage');
          } else {
            updateConnectionStatus('disconnected', 'No API Key', 'Please enter and save an API key');
          }
        };
        setInputs();
      } catch (error) {
        addDebugLog(`Failed to load configuration: ${error.message}`);
        updateConnectionStatus('disconnected', 'Config Load Failed', error.message);
      }
    }

    function setupAutoSaveListeners() {
      // Add input listeners for auto-save
      const inputs = ['openrouterKey', 'openrouterUrl', 'ollamaUrl'];
      inputs.forEach(inputId => {
        const element = document.getElementById(inputId);
        if (element) {
          element.addEventListener('input', debounce(autoSaveConfig, 1000));
          element.addEventListener('change', autoSaveConfig);
        }
      });
      
      const modelSelect = document.getElementById('modelSelect');
      if (modelSelect) {
        modelSelect.addEventListener('change', autoSaveConfig);
      }
    }

    // Debounce function to limit auto-save frequency
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    async function testOllamaConnection() {
      const url = document.getElementById('ollamaUrl').value;
      const statusElement = document.getElementById('ollamaStatus');
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 5000);
      try {
        addDebugLog('Testing Ollama connection...');
        statusElement.textContent = 'Testing...';
        const testUrl = url.replace('/api/chat', '/api/tags');
        const response = await fetch(testUrl, {
          method: 'GET',
          headers: { 'Accept': 'application/json' },
          signal: controller.signal
        });
        clearTimeout(timeoutId);
        if (response.ok) {
          statusElement.textContent = 'Connected ✓';
          statusElement.style.color = 'var(--success)';
          addDebugLog('Ollama connection successful');
          updateConnectionStatus('connected', 'Ollama Connected', 'Ready to chat');
          return true;
        } else {
          throw new Error(`Server responded with status: ${response.status}`);
        }
      } catch (error) {
        clearTimeout(timeoutId);
        statusElement.textContent = 'Connection failed ✗';
        statusElement.style.color = 'var(--error)';
        let errorMessage = error.message;
        if (error.name === 'AbortError') {
          errorMessage = 'Connection timed out after 5 seconds';
        } else if (error.message.includes('Failed to fetch')) {
          errorMessage = 'Unable to reach Ollama server.';
        }
        addDebugLog(`Ollama connection failed: ${errorMessage}`);
        updateConnectionStatus('disconnected', 'Connection Failed', errorMessage);
        return false;
      }
    }

    async function loadModels() {
      const modelSelect = document.getElementById('modelSelect');
      const cacheKey = `${currentProvider}_models`;
      const cached = getStorageItem(cacheKey);
      
      if (cached) {
        const { models, timestamp } = cached;
        if (Date.now() - timestamp < 24 * 60 * 60 * 1000) {
          modelSelect.innerHTML = '<option value="">Select a model</option>';
          models.forEach(model => {
            const option = document.createElement('option');
            option.value = model.id;
            option.textContent = model.name;
            modelSelect.appendChild(option);
          });
          updateConnectionStatus('connected', `${currentProvider} Connected`, `${models.length} models loaded from cache`);
          addDebugLog(`Loaded ${models.length} models from cache`);
          return;
        }
      }
      
      modelSelect.innerHTML = '<option value="">Loading models...</option>';
      try {
        updateConnectionStatus('loading', 'Loading Models', 'Please wait...');
        let models = [];
        
        if (currentProvider === 'openrouter') {
          const apiKey = document.getElementById('openrouterKey').value;
          if (!apiKey) {
            throw new Error('OpenRouter API key is required');
          }
          const response = await fetch('https://openrouter.ai/api/v1/models', {
            headers: {
              'Authorization': `Bearer ${apiKey}`,
              'Content-Type': 'application/json'
            }
          });
          if (!response.ok) {
            throw new Error(`Failed to fetch models: ${response.status}`);
          }
          const data = await response.json();
          models = data.data.map(model => ({ 
            id: model.id, 
            name: `${model.id} - ${model.pricing?.prompt || '0'}/1K tokens` 
          }));
        } else if (currentProvider === 'ollama') {
          const url = document.getElementById('ollamaUrl').value;
          const modelsUrl = url.replace('/api/chat', '/api/tags');
          const response = await fetch(modelsUrl);
          if (!response.ok) {
            throw new Error(`Failed to fetch Ollama models: ${response.status}`);
          }
          const data = await response.json();
          models = data.models?.map(model => ({
            id: model.name,
            name: `${model.name} (${Math.round(model.size / 1024 / 1024 / 1024 * 100) / 100}GB)`
          })) || [];
        }
        
        setStorageItem(cacheKey, { models, timestamp: Date.now() }, 1);
        
        modelSelect.innerHTML = '<option value="">Select a model</option>';
        models.forEach(model => {
          const option = document.createElement('option');
          option.value = model.id;
          option.textContent = model.name;
          modelSelect.appendChild(option);
        });
        
        updateConnectionStatus('connected', `${currentProvider} Connected`, `${models.length} models loaded`);
        addDebugLog(`Loaded ${models.length} ${currentProvider} models`);
        
        // Auto-save the updated model list
        autoSaveConfig();
      } catch (error) {
        modelSelect.innerHTML = '<option value="">Failed to load models</option>';
        updateConnectionStatus('disconnected', 'Connection Failed', error.message);
        addDebugLog(`Model loading failed: ${error.message}`);
      }
    }

    function sanitizeInput(input) {
      const div = document.createElement('div');
      div.textContent = input;
      return div.innerHTML;
    }

    async function sendMessage(tabName, message) {
      message = sanitizeInput(message.trim());
      if (!message) return;
      
      const chatBox = document.getElementById(`${tabName}ChatBox`);
      const input = document.getElementById(`${tabName}Input`);
      
      if (isStreaming) {
        addDebugLog('Already processing a message, please wait...');
        return;
      }
      
      const selectedModel = document.getElementById('modelSelect').value;
      if (!selectedModel) {
        addMessage(tabName, 'Please select a model first.', 'error');
        return;
      }
      
      addMessage(tabName, message, 'user');
      input.value = '';
      conversationHistories[tabName].push({ role: 'user', content: message });
      
      const thinkingDiv = document.createElement('div');
      thinkingDiv.className = 'message bot-message thinking';
      thinkingDiv.innerHTML = 'Thinking...';
      chatBox.appendChild(thinkingDiv);
      chatBox.scrollTop = chatBox.scrollHeight;
      
      isStreaming = true;
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 30000);
      
      try {
        let response;
        if (currentProvider === 'openrouter') {
          const apiKey = document.getElementById('openrouterKey').value;
          const apiUrl = document.getElementById('openrouterUrl').value;
          const messages = [
            {
              role: 'system',
              content: `You are a helpful healthcare assistant focused on ${tabName} health. Provide informative, accurate, and empathetic responses. Always remind users to consult healthcare professionals for serious concerns. Keep responses concise but comprehensive.`
            },
            ...conversationHistories[tabName]
          ];
          
          response = await fetch(apiUrl, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${apiKey}`,
              'Content-Type': 'application/json',
              'HTTP-Referer': window.location.origin,
              'X-Title': 'CureBot Health Assistant'
            },
            body: JSON.stringify({
              model: selectedModel,
              messages: messages,
              temperature: 0.7,
              max_tokens: 1000
            }),
            signal: controller.signal
          });
        } else if (currentProvider === 'ollama') {
          const apiUrl = document.getElementById('ollamaUrl').value;
          response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              model: selectedModel,
              messages: [
                {
                  role: 'system',
                  content: `You are a helpful healthcare assistant focused on ${tabName} health. Provide informative, accurate, and empathetic responses. Always remind users to consult healthcare professionals for serious concerns. Keep responses concise but comprehensive.`
                },
                ...conversationHistories[tabName]
              ],
              stream: false
            }),
            signal: controller.signal
          });
        }
        
        clearTimeout(timeoutId);
        chatBox.removeChild(thinkingDiv);
        
        if (!response.ok) {
          throw new Error(`API request failed: ${response.status} ${response.statusText}`);
        }
        
        const data = await response.json();
        let botResponse = '';
        
        if (currentProvider === 'openrouter') {
          if (!data.choices || !data.choices[0] || !data.choices[0].message || !data.choices[0].message.content) {
            throw new Error('Invalid response format from OpenRouter API');
          }
          botResponse = data.choices[0].message.content;
        } else if (currentProvider === 'ollama') {
          if (!data.message || !data.message.content) {
            throw new Error('Invalid response format from Ollama API');
          }
          botResponse = data.message.content;
        }
        
        addMessage(tabName, botResponse, 'bot');
        conversationHistories[tabName].push({ role: 'assistant', content: botResponse });
        addDebugLog(`Message sent successfully via ${currentProvider}`);
      } catch (error) {
        clearTimeout(timeoutId);
        if (thinkingDiv.parentNode) {
          chatBox.removeChild(thinkingDiv);
        }
        if (error.name === 'AbortError') {
          addMessage(tabName, 'Error: Request timed out after 30 seconds.', 'error');
          addDebugLog('Chat request timed out');
        } else {
          addMessage(tabName, `Error: ${error.message}`, 'error');
          addDebugLog(`Chat error: ${error.message}`);
        }
      } finally {
        isStreaming = false;
      }
    }

    function addMessage(tabName, message, type) {
      const chatBox = document.getElementById(`${tabName}ChatBox`);
      if (chatBox) {
        const messageDiv = document.createElement('div');
        if (type === 'user') {
          messageDiv.className = 'message user-message';
        } else if (type === 'error') {
          messageDiv.className = 'error-message';
        } else {
          messageDiv.className = 'message bot-message';
        }
        messageDiv.innerHTML = message.replace(/\n/g, '<br>');
        chatBox.appendChild(messageDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
      }
    }

    function clearChat(tabName) {
      const chatBox = document.getElementById(`${tabName}ChatBox`);
      if (chatBox) {
        chatBox.innerHTML = '';
        conversationHistories[tabName] = [];
        addDebugLog(`Chat cleared for ${tabName} tab`);
      }
    }

    async function exportChat(tabName, format) {
      const history = conversationHistories[tabName];
      if (history.length === 0) {
        alert('No chat history to export');
        return;
      }
      
      let content = `CureBot ${tabName.charAt(0).toUpperCase() + tabName.slice(1)} Health Chat Export\n`;
      content += `Generated on: ${new Date().toLocaleString()}\n\n`;
      history.forEach((msg, index) => {
        content += `${msg.role.toUpperCase()}: ${msg.content}\n\n`;
      });
      
      if (format === 'txt') {
        const blob = new Blob([content], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `curebot-${tabName}-chat.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      } else if (format === 'pdf') {
        if (typeof jspdf !== 'undefined') {
          const { jsPDF } = jspdf;
          const doc = new jsPDF();
          doc.setFontSize(10);
          doc.text(content, 10, 10);
          doc.save(`curebot-${tabName}-chat.pdf`);
        } else {
          alert('PDF export not supported. Please include jsPDF library.');
        }
      } else if (format === 'word') {
        alert('Word export not implemented. Please include docx library.');
      }
      addDebugLog(`Chat exported as ${format} for ${tabName}`);
    }

    document.addEventListener('DOMContentLoaded', function() {
      const loadingSpinner = document.getElementById('loadingSpinner');
      setTimeout(() => {
        if (loadingSpinner) {
          loadingSpinner.style.display = 'none';
        }
      }, 800);

      loadConfig();

      document.querySelectorAll('.provider-tab').forEach(tab => {
        tab.addEventListener('click', function() {
          currentProvider = this.dataset.provider;
          document.querySelectorAll('.provider-tab').forEach(t => t.classList.remove('active'));
          this.classList.add('active');
          document.getElementById('openrouter-config').style.display = currentProvider === 'openrouter' ? 'block' : 'none';
          document.getElementById('ollama-config').style.display = currentProvider === 'ollama' ? 'block' : 'none';
          updateConnectionStatus('disconnected', 'Not Connected', 'Configure your API settings');
          const modelSelect = document.getElementById('modelSelect');
          if (modelSelect) {
            modelSelect.innerHTML = '<option value="">Configure provider first</option>';
          }
          addDebugLog(`Switched to provider: ${currentProvider}`);
          autoSaveConfig();
        });
        tab.addEventListener('touchstart', function(e) {
          e.preventDefault();
          this.click();
        });
      });

      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', function() {
          const targetTab = this.dataset.tab;
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
          this.classList.add('active');
          const targetContent = document.getElementById(targetTab);
          if (targetContent) {
            targetContent.classList.add('active');
          }
          addDebugLog(`Switched to tab: ${targetTab}`);
        });
        tab.addEventListener('touchstart', function(e) {
          e.preventDefault();
          this.click();
        });
      });

      const testOllamaBtn = document.getElementById('testOllamaBtn');
      if (testOllamaBtn) {
        testOllamaBtn.addEventListener('click', testOllamaConnection);
        testOllamaBtn.addEventListener('touchstart', function(e) {
          e.preventDefault();
          testOllamaConnection();
        });
      }

      const loadModelsBtn = document.getElementById('loadModelsBtn');
      if (loadModelsBtn) {
        loadModelsBtn.addEventListener('click', loadModels);
        loadModelsBtn.addEventListener('touchstart', function(e) {
          e.preventDefault();
          loadModels();
        });
      }

      const saveConfigBtn = document.getElementById('saveConfigBtn');
      if (saveConfigBtn) {
        saveConfigBtn.addEventListener('click', saveConfig);
        saveConfigBtn.addEventListener('touchstart', function(e) {
          e.preventDefault();
          saveConfig();
        });
      }

      const refreshModelsBtn = document.getElementById('refreshModelsBtn');
      if (refreshModelsBtn) {
        refreshModelsBtn.addEventListener('click', loadModels);
        refreshModelsBtn.addEventListener('touchstart', function(e) {
          e.preventDefault();
          loadModels();
        });
      }

      const debugToggleBtn = document.getElementById('debugToggleBtn');
      if (debugToggleBtn) {
        debugToggleBtn.addEventListener('click', function() {
          const debugInfo = document.getElementById('debugInfo');
          if (debugInfo) {
            debugInfo.style.display = debugInfo.style.display === 'block' ? 'none' : 'block';
            addDebugLog(`Debug info ${debugInfo.style.display === 'block' ? 'shown' : 'hidden'}`);
          }
        });
        debugToggleBtn.addEventListener('touchstart', function(e) {
          e.preventDefault();
          this.click();
        });
      }

      tabs.forEach(tab => {
        const input = document.getElementById(`${tab}Input`);
        const sendBtn = document.getElementById(`${tab}Send`);
        const clearBtn = document.getElementById(`clearChatBtn${tab.charAt(0).toUpperCase()}`);

        if (sendBtn && input) {
          sendBtn.addEventListener('click', () => sendMessage(tab, input.value));
          sendBtn.addEventListener('touchstart', function(e) {
            e.preventDefault();
            sendMessage(tab, input.value);
          });
          input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
              e.preventDefault();
              sendMessage(tab, this.value);
            }
          });
        }

        if (clearBtn) {
          clearBtn.addEventListener('click', () => clearChat(tab));
          clearBtn.addEventListener('touchstart', function(e) {
            e.preventDefault();
            clearChat(tab);
          });
        }

        const quickQuestions = document.querySelectorAll(`#${tab} .quick-question`);
        quickQuestions.forEach(question => {
          const handleQuickQuestion = function(e) {
            e.preventDefault();
            if (isStreaming) return;
            question.setAttribute('aria-disabled', 'true');
            question.style.opacity = '0.6';
            if (input) {
              input.value = this.textContent;
              sendMessage(tab, this.textContent).finally(() => {
                question.setAttribute('aria-disabled', 'false');
                question.style.opacity = '1';
              });
            }
          };
          question.addEventListener('click', handleQuickQuestion);
          question.addEventListener('touchstart', handleQuickQuestion);
          question.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              handleQuickQuestion.call(this, e);
            }
          });
        });

        const exportBtn = document.getElementById(`exportBtn${tab.charAt(0).toUpperCase()}`);
        const exportMenu = document.getElementById(`exportMenu${tab.charAt(0).toUpperCase()}`);
        if (exportBtn && exportMenu) {
          exportBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            exportMenu.classList.toggle('show');
          });
          exportBtn.addEventListener('touchstart', function(e) {
            e.preventDefault();
            exportMenu.classList.toggle('show');
          });
          exportMenu.addEventListener('click', function(e) {
            if (e.target.classList.contains('export-option')) {
              const format = e.target.dataset.format;
              exportChat(tab, format);
              exportMenu.classList.remove('show');
            }
          });
          exportMenu.addEventListener('touchstart', function(e) {
            if (e.target.classList.contains('export-option')) {
              e.preventDefault();
              const format = e.target.dataset.format;
              exportChat(tab, format);
              exportMenu.classList.remove('show');
            }
          });
        }
      });

      document.addEventListener('click', function() {
        document.querySelectorAll('.export-menu').forEach(menu => {
          menu.classList.remove('show');
        });
      });

      document.addEventListener('touchstart', function(e) {
        if (!e.target.closest('.export-dropdown')) {
          document.querySelectorAll('.export-menu').forEach(menu => {
            menu.classList.remove('show');
          });
        }
      });

      // Set up auto-save listeners after DOM is ready
      setTimeout(() => {
        setupAutoSaveListeners();
      }, 1000);

      addDebugLog('CureBot initialized successfully with enhanced storage and auto-save');
    });
  </script>
</body>
</html>
