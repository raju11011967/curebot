<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Cure Health Bot</title>
  <script src="https://unpkg.com/jspdf@latest/dist/jspdf.umd.min.js" defer></script>
  <style>
    /* CSS Reset for consistent rendering */
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      /* Light theme variables */
      --primary: #3B82F6; /* Soft blue */
      --secondary: #6B7280; /* Neutral gray */
      --accent: #EC4899; /* Vibrant pink */
      --background: #F9FAFB; /* Light gray */
      --text: #111827; /* Dark gray for text */
      --error: #EF4444; /* Red for errors */
      --success: #22C55E; /* Green for success */
      --border: #D1D5DB; /* Light gray border */
      --shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      --gradient: linear-gradient(135deg, #3B82F6, #EC4899);
      --dark-background: #1F2937; /* Dark mode background */
      --dark-text: #F9FAFB; /* Dark mode text */
    }

    /* Dark theme */
    @media (prefers-color-scheme: dark) {
      :root {
        --background: #1F2937;
        --text: #F9FAFB;
        --border: #4B5563;
      }
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--background);
      min-height: 100vh;
      color: var(--text);
      display: flex;
      justify-content: center;
      padding: 8px;
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
    }

    /* Loading spinner */
    .loading-spinner {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }
    .spinner {
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      width: 36px;
      height: 36px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .container {
      width: 100%;
      max-width: 600px;
      background: var(--background);
      border-radius: 12px;
      box-shadow: var(--shadow);
      overflow: hidden;
      opacity: 0;
      animation: fadeIn 0.3s ease-out forwards;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    header {
      background: var(--gradient);
      color: var(--dark-text);
      padding: 12px;
      text-align: center;
    }
    header h1 {
      font-size: clamp(16px, 5vw, 20px);
      font-weight: 800;
      margin-bottom: 4px;
    }
    header p {
      margin: 0;
      opacity: 0.9;
      font-size: clamp(11px, 3vw, 13px);
    }

    .config-section {
      background: var(--dark-background);
      padding: 10px;
      color: var(--dark-text);
    }
    .config-grid {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 10px;
    }
    .config-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .config-group label {
      font-weight: 600;
      font-size: 12px;
    }
    .config-group input, .config-group select {
      padding: 8px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.1);
      color: var(--dark-text);
      font-size: 13px;
      width: 100%;
    }
    .config-group input::placeholder {
      color: rgba(255, 255, 255, 0.6);
    }
    .provider-tabs {
      display: flex;
      gap: 0;
      margin-bottom: 10px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }
    .provider-tabs::-webkit-scrollbar {
      display: none;
    }
    .provider-tab {
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid var(--border);
      color: var(--dark-text);
      cursor: pointer;
      transition: all 0.2s ease;
      white-space: nowrap;
      touch-action: manipulation;
      font-size: 12px;
      min-width: 80px;
      text-align: center;
    }
    .provider-tab.active {
      background: var(--primary);
      border-bottom: 2px solid var(--accent);
      color: var(--dark-text);
    }
    #llmStatus {
      background: var(--gradient);
      padding: 10px;
      color: var(--dark-text);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .status-info {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }
    .status-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .status-loading {
      background: #F59E0B;
      animation: pulse 1.5s infinite;
    }
    .status-connected {
      background: var(--success);
    }
    .status-disconnected {
      background: var(--error);
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }
    .model-selector {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .model-selector label {
      font-weight: 600;
      opacity: 0.95;
      font-size: 12px;
    }
    .model-selector select {
      padding: 6px 10px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.12);
      color: var(--dark-text);
      width: 100%;
      font-size: 12px;
    }
    .model-selector option {
      background: var(--dark-background);
      color: var(--dark-text);
      font-size: 11px;
    }
    .debug-info {
      background: rgba(0, 0, 0, 0.08);
      color: var(--dark-text);
      padding: 6px;
      border-radius: 6px;
      font-family: monospace;
      font-size: 10px;
      max-height: 80px;
      overflow-y: auto;
      overflow-x: hidden;
      scrollbar-width: thin;
      scrollbar-color: var(--primary) rgba(255, 255, 255, 0.1);
      width: 100%;
      display: none;
      word-break: break-all;
    }
    .debug-info::-webkit-scrollbar {
      width: 6px;
    }
    .debug-info::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
    }
    .debug-info::-webkit-scrollbar-thumb {
      background: var(--primary);
      border-radius: 3px;
    }
    .debug-toggle, .btn-small {
      padding: 6px 10px;
      border-radius: 8px;
      background: var(--primary);
      color: var(--dark-text);
      border: 1px solid var(--border);
      cursor: pointer;
      font-size: 12px;
      touch-action: manipulation;
      min-height: 44px;
    }
    .tabs {
      display: flex;
      background: linear-gradient(135deg, #93C5FD, #FCA5A5);
      gap: 0;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }
    .tabs::-webkit-scrollbar {
      display: none;
    }
    .tab {
      padding: 10px 8px;
      min-width: 70px;
      text-align: center;
      font-weight: 600;
      cursor: pointer;
      border-right: 1px solid var(--border);
      transition: all 0.2s ease;
      font-size: 11px;
      white-space: nowrap;
      touch-action: manipulation;
      color: var(--text);
    }
    .tab.active {
      background: var(--primary);
      color: var(--dark-text);
      transform: translateY(-2px);
    }
    .tab-content {
      display: none;
      padding: 0;
      background: var(--background);
    }
    .tab-content.active {
      display: block;
    }
    .chat-controls {
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 10px;
      background: linear-gradient(135deg, #E5E7EB, #D1D5DB);
      align-items: stretch;
    }
    .control-group {
      display: flex;
      gap: 8px;
      justify-content: center;
    }
    .btn {
      padding: 8px 12px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      background: var(--gradient);
      color: var(--dark-text);
      font-weight: 600;
      touch-action: manipulation;
      font-size: 12px;
      min-height: 44px;
    }
    .btn-secondary {
      background: linear-gradient(135deg, #FECACA, #FCA5A5);
      color: var(--text);
    }
    .export-dropdown {
      position: relative;
      display: inline-block;
      width: 100%;
    }
    .export-menu {
      display: none;
      position: absolute;
      top: 100%;
      right: 0;
      background: var(--background);
      border-radius: 6px;
      box-shadow: var(--shadow);
      z-index: 1000;
      min-width: 120px;
      border: 1px solid var(--border);
    }
    .export-menu.show {
      display: block;
    }
    .export-option {
      padding: 10px 12px;
      cursor: pointer;
      transition: background 0.2s;
      border-bottom: 1px solid var(--border);
      font-weight: 600;
      color: var(--text);
      touch-action: manipulation;
      font-size: 11px;
    }
    .export-option:hover {
      background: #E5E7EB;
    }
    .export-option:last-child {
      border-bottom: none;
    }
    .chat-section {
      height: 45vh;
      min-height: 250px;
      display: flex;
      flex-direction: column;
    }
    .chatBox {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 12px;
      background: var(--background);
      scrollbar-width: thin;
      scrollbar-color: var(--primary) var(--background);
      -webkit-overflow-scrolling: touch;
    }
    .chatBox::-webkit-scrollbar {
      width: 6px;
    }
    .chatBox::-webkit-scrollbar-track {
      background: var(--background);
      border-radius: 3px;
    }
    .chatBox::-webkit-scrollbar-thumb {
      background: var(--primary);
      border-radius: 3px;
    }
    .message {
      margin-bottom: 10px;
      max-width: 90%;
      animation: messageSlide 0.3s ease-out;
      word-wrap: break-word;
    }
    @keyframes messageSlide {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: none; }
    }
    .user-message {
      margin-left: auto;
      background: var(--gradient);
      color: var(--dark-text);
      padding: 10px 12px;
      border-radius: 12px 12px 4px 12px;
      font-size: 12px;
    }
    .bot-message {
      margin-right: auto;
      background: var(--background);
      padding: 10px 12px;
      border-radius: 12px 12px 12px 4px;
      border-left: 3px solid var(--primary);
      box-shadow: var(--shadow);
      font-size: 12px;
      line-height: 1.4;
      color: var(--text);
    }
    .input-container {
      display: flex;
      gap: 8px;
      padding: 10px;
      background: var(--background);
      align-items: center;
    }
    .chatInput {
      flex: 1;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      font-size: 13px;
      outline: none;
      background: #F3F4F6;
      color: var(--text);
      min-height: 44px;
    }
    .chatInput:focus {
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
      border-color: var(--primary);
      background: var(--background);
    }
    .sendBtn {
      padding: 10px 16px;
      border-radius: 12px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      background: var(--gradient);
      color: var(--dark-text);
      touch-action: manipulation;
      font-size: 12px;
      min-height: 44px;
    }
    .quick-questions {
      padding: 10px;
      background: linear-gradient(135deg, #93C5FD, #FCA5A5);
    }
    .questions-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
    }
    .quick-question {
      background: var(--background);
      padding: 10px;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: var(--shadow);
      font-weight: 600;
      text-align: center;
      transition: transform 0.2s ease, opacity 0.2s ease;
      touch-action: manipulation;
      font-size: 12px;
      color: var(--text);
      min-height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .quick-question:hover {
      transform: translateY(-2px);
    }
    .quick-question[aria-disabled="true"] {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .disclaimer {
      padding: 10px;
      margin: 10px;
      border-radius: 8px;
      font-size: 11px;
      background: linear-gradient(135deg, #FEE2E2, #FECACA);
      border-left: 3px solid var(--error);
      color: var(--text);
    }
    .thinking {
      opacity: 0.7;
      font-style: italic;
    }
    .error-message {
      background: #FEE2E2;
      color: var(--error);
      padding: 10px 12px;
      border-radius: 12px 12px 12px 4px;
      border-left: 3px solid var(--error);
      margin-bottom: 10px;
      max-width: 90%;
      font-size: 12px;
    }
    @media (max-width: 768px) {
      body { padding: 5px; }
      .container { max-width: 100%; border-radius: 8px; }
      header { padding: 10px; }
      .config-section { padding: 8px; }
      .chat-section { height: 45vh; min-height: 200px; }
      .chatBox { padding: 10px; }
      .input-container { padding: 8px; gap: 6px; }
      .quick-questions { padding: 8px; }
      .questions-grid { gap: 6px; }
      .tab { padding: 8px 6px; font-size: 10px; min-width: 60px; }
      .model-selector select { font-size: 12px; }
      #llmStatus { padding: 8px; }
      .status-info { gap: 6px; }
      .chat-controls { padding: 8px; }
      .control-group { flex-direction: column; gap: 6px; }
      .message { max-width: 95%; }
      .btn, .sendBtn, .quick-question { min-height: 48px; }
    }
    @media (max-width: 480px) {
      .chat-section { height: 40vh; min-height: 180px; }
      .quick-question { padding: 8px; font-size: 11px; }
      .btn, .sendBtn { padding: 8px 12px; font-size: 11px; }
      .chatInput { padding: 8px; font-size: 12px; }
      header h1 { font-size: 18px; }
      header p { font-size: 12px; }
    }
  </style>
</head>
<body>
  <div class="loading-spinner" id="loadingSpinner">
    <div class="spinner"></div>
  </div>
  <div class="container">
    <header>
      <h1>Cure Health Bot</h1>
      <p>Your AI-powered health companion with 300+ models</p>
    </header>
    <div class="config-section">
      <div class="provider-tabs">
        <div class="provider-tab active" data-provider="openrouter">OpenRouter</div>
        <div class="provider-tab" data-provider="ollama">Ollama</div>
      </div>
      <div id="openrouter-config" class="provider-config">
        <div class="config-grid">
          <div class="config-group">
            <label for="openrouterKey">OpenRouter API Key</label>
            <input type="password" id="openrouterKey" placeholder="sk-or-v1-...">
          </div>
          <div class="config-group">
            <label for="openrouterUrl">OpenRouter URL</label>
            <input type="text" id="openrouterUrl" value="https://openrouter.ai/api/v1/chat/completions">
          </div>
        </div>
      </div>
      <div id="ollama-config" class="provider-config" style="display: none;">
        <div class="config-grid">
          <div class="config-group">
            <label for="ollamaUrl">Ollama Server URL</label>
            <input type="text" id="ollamaUrl" value="http://localhost:11434/api/chat">
          </div>
          <div class="config-group">
            <label>Connection Status</label>
            <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
              <span id="ollamaStatus">Not connected</span>
              <button class="btn-small" id="testOllamaBtn">Test Connection</button>
            </div>
          </div>
        </div>
      </div>
      <div style="display: flex; gap: 8px; justify-content: flex-end; flex-wrap: wrap;">
        <button class="btn-small" id="loadModelsBtn">Load Models</button>
        <button class="btn-small" id="saveConfigBtn">Save Config</button>
      </div>
    </div>
    <div id="llmStatus">
      <div class="status-info">
        <span id="statusIndicator" class="status-indicator status-disconnected"></span>
        <div>
          <div id="statusText" style="font-weight: 600;">Not Connected</div>
          <div style="font-size: 11px; opacity: 0.95;" id="statusSub">Configure your API settings</div>
        </div>
        <button class="debug-toggle" id="debugToggleBtn">Debug Info</button>
      </div>
      <div class="model-selector">
        <label for="modelSelect">AI Model</label>
        <select id="modelSelect" aria-label="Select AI model">
          <option value="">Configure provider first</option>
        </select>
        <button class="btn-small" id="refreshModelsBtn">Refresh</button>
      </div>
      <div id="debugInfo" class="debug-info">
        <div id="debugLog">Configure your provider to get started...</div>
      </div>
    </div>
    <div class="tabs" role="tablist" aria-label="Sections">
      <div class="tab active" data-tab="general">General Health</div>
      <div class="tab" data-tab="diabetes">Diabetes Care</div>
      <div class="tab" data-tab="heart">Heart Health</div>
      <div class="tab" data-tab="mental">Mental Wellness</div>
      <div class="tab" data-tab="respiratory">Respiratory</div>
      <div class="tab" data-tab="women">Women's Health</div>
      <div class="tab" data-tab="elderly">Elderly Care</div>
      <div class="tab" data-tab="pediatric">Pediatric Health</div>
    </div>
    <div id="general" class="tab-content active">
      <div class="chat-controls">
        <div class="control-group">
          <button class="btn btn-secondary" id="clearChatBtn">Clear Chat</button>
        </div>
        <div class="control-group">
          <div class="export-dropdown">
            <button class="btn btn-secondary" id="exportBtn">Export Chat ▼</button>
            <div class="export-menu" id="exportMenu">
              <div class="export-option" data-format="pdf" data-tab="general">📄 Export as PDF</div>
              <div class="export-option" data-format="word" data-tab="general">📝 Export as Word</div>
              <div class="export-option" data-format="txt" data-tab="general">📋 Export as Text</div>
            </div>
          </div>
        </div>
      </div>
      <div class="chat-section">
        <div class="chatBox" id="generalChatBox" aria-live="polite"></div>
        <div class="input-container">
          <input class="chatInput" id="generalInput" placeholder="Ask about general health..." maxlength="1000">
          <button class="sendBtn" id="generalSend" aria-label="Send message">Send</button>
        </div>
      </div>
      <div class="quick-questions">
        <h3 style="text-align: center; margin-bottom: 10px; font-size: 13px;">Quick Health Questions</h3>
        <div class="questions-grid">
          <div class="quick-question" role="button" tabindex="0" aria-label="Ask about common cold symptoms">What are common cold symptoms?</div>
          <div class="quick-question" role="button" tabindex="0" aria-label="Ask how to boost immune system naturally">How to boost immune system naturally?</div>
          <div class="quick-question" role="button" tabindex="0" aria-label="Ask about the healthiest foods to eat daily">What foods are healthiest to eat daily?</div>
          <div class="quick-question" role="button" tabindex="0" aria-label="Ask how much water to drink daily">How much water should I drink daily?</div>
        </div>
      </div>
    </div>
    <div id="diabetes" class="tab-content">
      <div class="chat-controls">
        <div class="control-group">
          <button class="btn btn-secondary" id="clearChatBtnD">Clear Chat</button>
        </div>
        <div class="control-group">
          <div class="export-dropdown">
            <button class="btn btn-secondary" id="exportBtnD">Export Chat ▼</button>
            <div class="export-menu" id="exportMenuD">
              <div class="export-option" data-format="pdf" data-tab="diabetes">📄 Export as PDF</div>
              <div class="export-option" data-format="word" data-tab="diabetes">📝 Export as Word</div>
              <div class="export-option" data-format="txt" data-tab="diabetes">📋 Export as Text</div>
            </div>
          </div>
        </div>
      </div>
      <div class="chat-section">
        <div class="chatBox" id="diabetesChatBox" aria-live="polite"></div>
        <div class="input-container">
          <input class="chatInput" id="diabetesInput" placeholder="Ask about diabetes management..." maxlength="1000">
          <button class="sendBtn" id="diabetesSend" aria-label="Send message">Send</button>
        </div>
      </div>
      <div class="quick-questions">
        <h3 style="text-align: center; margin-bottom: 10px; font-size: 13px;">Diabetes Care Questions</h3>
        <div class="questions-grid">
          <div class="quick-question" role="button" tabindex="0" aria-label="Ask what foods diabetics should avoid">What foods should diabetics avoid?</div>
          <div class="quick-question" role="button" tabindex="0" aria-label="Ask how to monitor blood sugar properly">How to monitor blood sugar properly?</div>
          <div class="quick-question" role="button" tabindex="0" aria-label="Ask about best exercises for diabetes management">Best exercises for diabetes management</div>
          <div class="quick-question" role="button" tabindex="0" aria-label="Ask about signs of low blood sugar">What are signs of low blood sugar?</div>
        </div>
      </div>
    </div>
    <div id="heart" class="tab-content">
      <div class="chat-controls">
        <div class="control-group">
          <button class="btn btn-secondary" id="clearChatBtnH">Clear Chat</button>
        </div>
        <div class="control-group">
          <div class="export-dropdown">
            <button class="btn btn-secondary" id="exportBtnH">Export Chat ▼</button>
            <div class="export-menu" id="exportMenuH">
              <div class="export-option" data-format="pdf" data-tab="heart">📄 Export as PDF</div>
              <div class="export-option" data-format="word" data-tab="heart">📝 Export as Word</div>
              <div class="export-option" data-format="txt" data-tab="heart">📋 Export as Text</div>
            </div>
          </div>
        </div>
      </div>
      <div class="chat-section">
        <div class="chatBox" id="heartChatBox" aria-live="polite"></div>
        <div class="input-container">
          <input class="chatInput" id="heartInput" placeholder="Ask about heart health..." maxlength="1000">
          <button class="sendBtn" id="heartSend" aria-label="Send message">Send</button>
        </div>
      </div>
      <div class="quick-questions">
        <h3 style="text-align: center; margin-bottom: 10px; font-size: 13px;">Heart Health Questions</h3>
        <div class="questions-grid">
          <div class="quick-question" role="button" tabindex="0" aria-label="Ask about normal blood pressure range">What is normal blood pressure range?</div>
          <div class="quick-question" role="button" tabindex="0" aria-label="Ask how to control cholesterol naturally">How to control cholesterol naturally?</div>
          <div class="quick-question" role="button" tabindex="0" aria-label="Ask about best exercises for heart health">What exercises are best for heart health?</div>
          <div class="quick-question" role="button" tabindex="0" aria-label="Ask about best heart-healthy foods">What are the best heart-healthy foods?</div>
        </div>
      </div>
    </div>
    <div id="mental" class="tab-content">
      <div class="chat-controls">
        <div class="control-group">
          <button class="btn btn-secondary" id="clearChatBtnM">Clear Chat</button>
        </div>
        <div class="control-group">
          <div class="export-dropdown">
            <button class="btn btn-secondary" id="exportBtnM">Export Chat ▼</button>
            <div class="export-menu" id="exportMenuM">
              <div class="export-option" data-format="pdf" data-tab="mental">📄 Export as PDF</div>
              <div class="export-option" data-format="word" data-tab="mental">📝 Export as Word</div>
              <div class="export-option" data-format="txt" data-tab="mental">📋 Export as Text</div>
            </div>
          </div>
        </div>
      </div>
      <div class="chat-section">
        <div class="chatBox" id="mentalChatBox" aria-live="polite"></div>
        <div class="input-container">
          <input class="chatInput" id="mentalInput" placeholder="Ask about mental wellness..." maxlength="1000">
          <button class="sendBtn" id="mentalSend" aria-label="Send message">Send</button>
        </div>
      </div>
      <div class="quick-questions">
        <h3 style="text-align: center; margin-bottom: 10px; font-size: 13px;">Mental Wellness Questions</h3>
        <div class="questions-grid">
          <div class="quick-question" role="button" tabindex="0" aria-label="Ask how to manage stress effectively">How to manage stress effectively?</div>
          <div class="quick-question" role="button" tabindex="0" aria-label="Ask about tips for better sleep hygiene">Tips for better sleep hygiene</div>
          <div class="quick-question" role="button" tabindex="0" aria-label="Ask how to practice mindfulness daily">How to practice mindfulness daily?</div>
          <div class="quick-question" role="button" tabindex="0" aria-label="Ask about ways to cope with anxiety">Ways to cope with anxiety</div>
        </div>
      </div>
    </div>
    <div id="respiratory" class="tab-content">
      <div class="chat-controls">
        <div class="control-group">
          <button class="btn btn-secondary" id="clearChatBtnR">Clear Chat</button>
        </div>
        <div class="control-group">
          <div class="export-dropdown">
            <button class="btn btn-secondary" id="exportBtnR">Export Chat ▼</button>
            <div class="export-menu" id="exportMenuR">
              <div class="export-option" data-format="pdf" data-tab="respiratory">📄 Export as PDF</div>
              <div class="export-option" data-format="word" data-tab="respiratory">📝 Export as Word</div>
              <div class="export-option" data-format="txt" data-tab="respiratory">📋 Export as Text</div>
            </div>
          </div>
        </div>
      </div>
      <div class="chat-section">
        <div class="chatBox" id="respiratoryChatBox" aria-live="polite"></div>
        <div class="input-container">
          <input class="chatInput" id="respiratoryInput" placeholder="Ask about respiratory health..." maxlength="1000">
          <button class="sendBtn" id="respiratorySend" aria-label="Send message">Send</button>
        </div>
      </div>
      <div class="quick-questions">
        <h3 style="text-align: center; margin-bottom: 10px; font-size: 13px;">Respiratory Health Questions</h3>
        <div class="questions-grid">
          <div class="quick-question" role="button" tabindex="0" aria-label="Ask how to improve lung capacity naturally">How to improve lung capacity naturally?</div>
          <div class="quick-question" role="button" tabindex="0" aria-label="Ask about signs of asthma">What are signs of asthma?</div>
          <div class="quick-question" role="button" tabindex="0" aria-label="Ask about breathing exercises for better health">Breathing exercises for better health</div>
          <div class="quick-question" role="button" tabindex="0" aria-label="Ask how to prevent respiratory infections">How to prevent respiratory infections?</div>
        </div>
      </div>
    </div>
    <div id="women" class="tab-content">
      <div class="chat-controls">
        <div class="control-group">
          <button class="btn btn-secondary" id="clearChatBtnW">Clear Chat</button>
        </div>
        <div class="control-group">
          <div class="export-dropdown">
            <button class="btn btn-secondary" id="exportBtnW">Export Chat ▼</button>
            <div class="export-menu" id="exportMenuW">
              <div class="export-option" data-format="pdf" data-tab="women">📄 Export as PDF</div>
              <div class="export-option" data-format="word" data-tab="women">📝 Export as Word</div>
              <div class="export-option" data-format="txt" data-tab="women">📋 Export as Text</div>
            </div>
          </div>
        </div>
      </div>
      <div class="chat-section">
        <div class="chatBox" id="womenChatBox" aria-live="polite"></div>
        <div class="input-container">
          <input class="chatInput" id="womenInput" placeholder="Ask about women's health..." maxlength="1000">
          <button class="sendBtn" id="womenSend" aria-label="Send message">Send</button>
        </div>
      </div>
      <div class="quick-questions">
        <h3 style="text-align: center; margin-bottom: 10px; font-size: 13px;">Women's Health Questions</h3>
        <div class="questions-grid">
          <div class="quick-question" role="button" tabindex="0" aria-label="Ask about common signs of hormonal imbalance">What are common signs of hormonal imbalance?</div>
          <div class="quick-question" role="button" tabindex="0" aria-label="Ask how to maintain reproductive health">How to maintain reproductive health?</div>
          <div class="quick-question" role="button" tabindex="0" aria-label="Ask about nutrition during pregnancy">Nutrition during pregnancy</div>
          <div class="quick-question" role="button" tabindex="0" aria-label="Ask about managing menopause symptoms naturally">Managing menopause symptoms naturally</div>
        </div>
      </div>
    </div>
    <div id="elderly" class="tab-content">
      <div class="chat-controls">
        <div class="control-group">
          <button class="btn btn-secondary" id="clearChatBtnE">Clear Chat</button>
        </div>
        <div class="control-group">
          <div class="export-dropdown">
            <button class="btn btn-secondary" id="exportBtnE">Export Chat ▼</button>
            <div class="export-menu" id="exportMenuE">
              <div class="export-option" data-format="pdf" data-tab="elderly">📄 Export as PDF</div>
              <div class="export-option" data-format="word" data-tab="elderly">📝 Export as Word</div>
              <div class="export-option" data-format="txt" data-tab="elderly">📋 Export as Text</div>
            </div>
          </div>
        </div>
      </div>
      <div class="chat-section">
        <div class="chatBox" id="elderlyChatBox" aria-live="polite"></div>
        <div class="input-container">
          <input class="chatInput" id="elderlyInput" placeholder="Ask about elderly care..." maxlength="1000">
          <button class="sendBtn" id="elderlySend" aria-label="Send message">Send</button>
        </div>
      </div>
      <div class="quick-questions">
        <h3 style="text-align: center; margin-bottom: 10px; font-size: 13px;">Elderly Care Questions</h3>
        <div class="questions-grid">
          <div class="quick-question" role="button" tabindex="0" aria-label="Ask how to prevent falls in elderly">How to prevent falls in elderly?</div>
          <div class="quick-question" role="button" tabindex="0" aria-label="Ask about managing multiple medications safely">Managing multiple medications safely</div>
          <div class="quick-question" role="button" tabindex="0" aria-label="Ask about maintaining cognitive health with age">Maintaining cognitive health with age</div>
          <div class="quick-question" role="button" tabindex="0" aria-label="Ask about nutrition needs for seniors">Nutrition needs for seniors</div>
        </div>
      </div>
    </div>
    <div id="pediatric" class="tab-content">
      <div class="chat-controls">
        <div class="control-group">
          <button class="btn btn-secondary" id="clearChatBtnP">Clear Chat</button>
        </div>
        <div class="control-group">
          <div class="export-dropdown">
            <button class="btn btn-secondary" id="exportBtnP">Export Chat ▼</button>
            <div class="export-menu" id="exportMenuP">
              <div class="export-option" data-format="pdf" data-tab="pediatric">📄 Export as PDF</div>
              <div class="export-option" data-format="word" data-tab="pediatric">📝 Export as Word</div>
              <div class="export-option" data-format="txt" data-tab="pediatric">📋 Export as Text</div>
            </div>
          </div>
        </div>
      </div>
      <div class="chat-section">
        <div class="chatBox" id="pediatricChatBox" aria-live="polite"></div>
        <div class="input-container">
          <input class="chatInput" id="pediatricInput" placeholder="Ask about pediatric health..." maxlength="1000">
          <button class="sendBtn" id="pediatricSend" aria-label="Send message">Send</button>
        </div>
      </div>
      <div class="quick-questions">
        <h3 style="text-align: center; margin-bottom: 10px; font-size: 13px;">Pediatric Health Questions</h3>
        <div class="questions-grid">
          <div class="quick-question" role="button" tabindex="0" aria-label="Ask about vaccination schedule for children">Vaccination schedule for children</div>
          <div class="quick-question" role="button" tabindex="0" aria-label="Ask about managing childhood obesity">Managing childhood obesity</div>
          <div class="quick-question" role="button" tabindex="0" aria-label="Ask when to be concerned about fever">When to be concerned about fever?</div>
          <div class="quick-question" role="button" tabindex="0" aria-label="Ask about healthy eating habits for kids">Healthy eating habits for kids</div>
        </div>
      </div>
    </div>
    <div class="disclaimer">
      <strong>⚠️ Medical Disclaimer:</strong> This bot provides general health information only and should not replace professional medical advice. Always consult with healthcare professionals for medical concerns.
    </div>
  </div>
  <script>
    let currentProvider = 'openrouter';
    let conversationHistories = {};
    let isStreaming = false;
    const tabs = ['general', 'diabetes', 'heart', 'mental', 'respiratory', 'women', 'elderly', 'pediatric'];
    tabs.forEach(tab => {
      conversationHistories[tab] = [];
    });

    function addDebugLog(message) {
      const debugLog = document.getElementById('debugLog');
      if (debugLog) {
        const timestamp = new Date().toLocaleTimeString();
        debugLog.innerHTML += `[${timestamp}] ${message}<br>`;
        debugLog.scrollTop = debugLog.scrollHeight;
      }
    }

    function updateConnectionStatus(status, message, subMessage = '') {
      const indicator = document.getElementById('statusIndicator');
      const text = document.getElementById('statusText');
      const sub = document.getElementById('statusSub');
      if (indicator && text && sub) {
        indicator.className = `status-indicator status-${status}`;
        text.textContent = message;
        sub.textContent = subMessage;
        addDebugLog(`Status: ${status} - ${message}`);
      }
    }

    function setCookie(name, value, days) {
      let expires = "";
      if (days) {
        const date = new Date();
        date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
        expires = "; expires=" + date.toUTCString();
      }
      document.cookie = name + "=" + encodeURIComponent(value) + expires + "; path=/; SameSite=Strict";
    }

    function getCookie(name) {
      const nameEQ = name + "=";
      const ca = document.cookie.split(';');
      for (let c of ca) {
        c = c.trim();
        if (c.indexOf(nameEQ) === 0) return decodeURIComponent(c.substring(nameEQ.length));
      }
      return null;
    }

    function saveConfig() {
      try {
        const openrouterKeyElement = document.getElementById('openrouterKey');
        if (!openrouterKeyElement) {
          throw new Error('OpenRouter API key input not found');
        }
        const openrouterKey = openrouterKeyElement.value.trim();
        if (!openrouterKey) {
          addDebugLog('Warning: OpenRouter API key is empty');
          alert('Please enter an OpenRouter API key.');
          return;
        }
        const config = {
          provider: currentProvider,
          openrouter: {
            key: openrouterKey,
            url: document.getElementById('openrouterUrl').value.trim() || 'https://openrouter.ai/api/v1/chat/completions'
          },
          ollama: {
            url: document.getElementById('ollamaUrl').value.trim() || 'http://localhost:11434/api/chat'
          },
          selectedModel: document.getElementById('modelSelect').value || ''
        };
        setCookie('curebotConfig', JSON.stringify(config), 30);
        addDebugLog(`Configuration saved: API key (${openrouterKey.slice(0, 4)}...)`);
        alert('Configuration saved successfully!');
      } catch (error) {
        addDebugLog(`Failed to save configuration: ${error.message} (UA: ${navigator.userAgent})`);
        alert(`Error saving configuration: ${error.message}`);
      }
    }

    function loadConfig() {
      try {
        const saved = getCookie('curebotConfig');
        if (!saved) {
          addDebugLog('No configuration found in cookies (UA: ' + navigator.userAgent + ')');
          return;
        }
        const config = JSON.parse(saved);
        if (!config || typeof config !== 'object') {
          throw new Error('Invalid configuration format');
        }
        currentProvider = config.provider || 'openrouter';
        let retries = 0;
        const maxRetries = 5;
        const setInputs = () => {
          const openrouterKeyElement = document.getElementById('openrouterKey');
          if (!openrouterKeyElement && retries < maxRetries) {
            addDebugLog(`OpenRouter key input not ready, retry ${retries + 1}/${maxRetries}`);
            retries++;
            setTimeout(setInputs, 100);
            return;
          }
          if (!openrouterKeyElement) {
            throw new Error('OpenRouter key input not found after retries');
          }
          openrouterKeyElement.value = config.openrouter?.key || '';
          document.getElementById('openrouterUrl').value = config.openrouter?.url || 'https://openrouter.ai/api/v1/chat/completions';
          document.getElementById('ollamaUrl').value = config.ollama?.url || 'http://localhost:11434/api/chat';
          document.querySelectorAll('.provider-tab').forEach(tab => {
            tab.classList.toggle('active', tab.dataset.provider === currentProvider);
          });
          document.getElementById('openrouter-config').style.display = currentProvider === 'openrouter' ? 'block' : 'none';
          document.getElementById('ollama-config').style.display = currentProvider === 'ollama' ? 'block' : 'none';
          if (config.selectedModel) {
            const modelSelect = document.getElementById('modelSelect');
            const optionExists = Array.from(modelSelect.options).some(opt => opt.value === config.selectedModel);
            if (optionExists) {
              modelSelect.value = config.selectedModel;
            }
          }
          addDebugLog(`Configuration loaded: API key (${config.openrouter?.key ? config.openrouter.key.slice(0, 4) + '...' : 'none'})`);
          if (config.openrouter?.key) {
            updateConnectionStatus('connected', 'Configuration Loaded', 'API key retrieved');
          }
        };
        setInputs();
      } catch (error) {
        addDebugLog(`Failed to load configuration: ${error.message} (UA: ${navigator.userAgent})`);
        updateConnectionStatus('disconnected', 'Config Load Failed', error.message);
      }
    }

    async function testOllamaConnection() {
      const url = document.getElementById('ollamaUrl').value;
      const statusElement = document.getElementById('ollamaStatus');
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 5000);
      try {
        addDebugLog('Testing Ollama connection...');
        statusElement.textContent = 'Testing...';
        const testUrl = url.replace('/api/chat', '/api/tags');
        const response = await fetch(testUrl, {
          method: 'GET',
          headers: { 'Accept': 'application/json' },
          signal: controller.signal
        });
        clearTimeout(timeoutId);
        if (response.ok) {
          statusElement.textContent = 'Connected ✓';
          statusElement.style.color = '#22c55e';
          addDebugLog('Ollama connection successful');
          updateConnectionStatus('connected', 'Ollama Connected', 'Ready to chat');
          return true;
        } else {
          throw new Error(`Server responded with status: ${response.status}`);
        }
      } catch (error) {
        clearTimeout(timeoutId);
        statusElement.textContent = 'Connection failed ✗';
        statusElement.style.color = '#ef4444';
        let errorMessage = error.message;
        if (error.name === 'AbortError') {
          errorMessage = 'Connection timed out after 5 seconds';
        } else if (error.message.includes('Failed to fetch')) {
          errorMessage = 'Unable to reach Ollama server.';
        }
        addDebugLog(`Ollama connection failed: ${errorMessage}`);
        updateConnectionStatus('disconnected', 'Connection Failed', errorMessage);
        return false;
      }
    }

    async function loadModels() {
      const modelSelect = document.getElementById('modelSelect');
      const cacheKey = `${currentProvider}_models`;
      const cached = localStorage.getItem(cacheKey);
      if (cached) {
        const { models, timestamp } = JSON.parse(cached);
        if (Date.now() - timestamp < 24 * 60 * 60 * 1000) {
          modelSelect.innerHTML = '<option value="">Select a model</option>';
          models.forEach(model => {
            const option = document.createElement('option');
            option.value = model.id;
            option.textContent = model.name;
            modelSelect.appendChild(option);
          });
          updateConnectionStatus('connected', `${currentProvider} Connected`, `${models.length} models loaded from cache`);
          addDebugLog(`Loaded ${models.length} models from cache`);
          return;
        }
      }
      modelSelect.innerHTML = '<option value="">Loading models...</option>';
      try {
        updateConnectionStatus('loading', 'Loading Models', 'Please wait...');
        let models = [];
        if (currentProvider === 'openrouter') {
          const apiKey = document.getElementById('openrouterKey').value;
          if (!apiKey) {
            throw new Error('OpenRouter API key is required');
          }
          const response = await fetch('https://openrouter.ai/api/v1/models', {
            headers: {
              'Authorization': `Bearer ${apiKey}`,
              'Content-Type': 'application/json'
            }
          });
          if (!response.ok) {
            throw new Error(`Failed to fetch models: ${response.status}`);
          }
          const data = await response.json();
          models = data.data.map(model => ({ id: model.id, name: `${model.id} - ${model.pricing?.prompt || '0'}/1K tokens` }));
        } else if (currentProvider === 'ollama') {
          const url = document.getElementById('ollamaUrl').value;
          const modelsUrl = url.replace('/api/chat', '/api/tags');
          const response = await fetch(modelsUrl);
          if (!response.ok) {
            throw new Error(`Failed to fetch Ollama models: ${response.status}`);
          }
          const data = await response.json();
          models = data.models?.map(model => ({
            id: model.name,
            name: `${model.name} (${Math.round(model.size / 1024 / 1024 / 1024 * 100) / 100}GB)`
          })) || [];
        }
        localStorage.setItem(cacheKey, JSON.stringify({ models, timestamp: Date.now() }));
        modelSelect.innerHTML = '<option value="">Select a model</option>';
        models.forEach(model => {
          const option = document.createElement('option');
          option.value = model.id;
          option.textContent = model.name;
          modelSelect.appendChild(option);
        });
        updateConnectionStatus('connected', `${currentProvider} Connected`, `${models.length} models loaded`);
        addDebugLog(`Loaded ${models.length} ${currentProvider} models`);
      } catch (error) {
        modelSelect.innerHTML = '<option value="">Failed to load models</option>';
        updateConnectionStatus('disconnected', 'Connection Failed', error.message);
        addDebugLog(`Model loading failed: ${error.message}`);
      }
    }

    function sanitizeInput(input) {
      const div = document.createElement('div');
      div.textContent = input;
      return div.innerHTML;
    }

    async function sendMessage(tabName, message) {
      message = sanitizeInput(message.trim());
      if (!message) return;
      const chatBox = document.getElementById(`${tabName}ChatBox`);
      const input = document.getElementById(`${tabName}Input`);
      if (isStreaming) {
        addDebugLog('Already processing a message, please wait...');
        return;
      }
      const selectedModel = document.getElementById('modelSelect').value;
      if (!selectedModel) {
        addMessage(tabName, 'Please select a model first.', 'error');
        return;
      }
      addMessage(tabName, message, 'user');
      input.value = '';
      conversationHistories[tabName].push({ role: 'user', content: message });
      const thinkingDiv = document.createElement('div');
      thinkingDiv.className = 'message bot-message thinking';
      thinkingDiv.innerHTML = 'Thinking...';
      chatBox.appendChild(thinkingDiv);
      chatBox.scrollTop = chatBox.scrollHeight;
      isStreaming = true;
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 30000);
      try {
        let response;
        if (currentProvider === 'openrouter') {
          const apiKey = document.getElementById('openrouterKey').value;
          const apiUrl = document.getElementById('openrouterUrl').value;
          const messages = [
            {
              role: 'system',
              content: `You are a helpful healthcare assistant focused on ${tabName} health. Provide informative, accurate, and empathetic responses. Always remind users to consult healthcare professionals for serious concerns. Keep responses concise but comprehensive.`
            },
            ...conversationHistories[tabName]
          ];
          response = await fetch(apiUrl, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${apiKey}`,
              'Content-Type': 'application/json',
              'HTTP-Referer': window.location.origin,
              'X-Title': 'CureBot Health Assistant'
            },
            body: JSON.stringify({
              model: selectedModel,
              messages: messages,
              temperature: 0.7,
              max_tokens: 1000
            }),
            signal: controller.signal
          });
        } else if (currentProvider === 'ollama') {
          const apiUrl = document.getElementById('ollamaUrl').value;
          response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              model: selectedModel,
              messages: [
                {
                  role: 'system',
                  content: `You are a helpful healthcare assistant focused on ${tabName} health. Provide informative, accurate, and empathetic responses. Always remind users to consult healthcare professionals for serious concerns. Keep responses concise but comprehensive.`
                },
                ...conversationHistories[tabName]
              ],
              stream: false
            }),
            signal: controller.signal
          });
        }
        clearTimeout(timeoutId);
        chatBox.removeChild(thinkingDiv);
        if (!response.ok) {
          throw new Error(`API request failed: ${response.status} ${response.statusText}`);
        }
        const data = await response.json();
        let botResponse = '';
        if (currentProvider === 'openrouter') {
          if (!data.choices || !data.choices[0] || !data.choices[0].message || !data.choices[0].message.content) {
            throw new Error('Invalid response format from OpenRouter API');
          }
          botResponse = data.choices[0].message.content;
        } else if (currentProvider === 'ollama') {
          if (!data.message || !data.message.content) {
            throw new Error('Invalid response format from Ollama API');
          }
          botResponse = data.message.content;
        }
        addMessage(tabName, botResponse, 'bot');
        conversationHistories[tabName].push({ role: 'assistant', content: botResponse });
        addDebugLog(`Message sent successfully via ${currentProvider}`);
      } catch (error) {
        clearTimeout(timeoutId);
        if (thinkingDiv.parentNode) {
          chatBox.removeChild(thinkingDiv);
        }
        if (error.name === 'AbortError') {
          addMessage(tabName, 'Error: Request timed out after 30 seconds.', 'error');
          addDebugLog('Chat request timed out');
        } else {
          addMessage(tabName, `Error: ${error.message}`, 'error');
          addDebugLog(`Chat error: ${error.message}`);
        }
      } finally {
        isStreaming = false;
      }
    }

    function addMessage(tabName, message, type) {
      const chatBox = document.getElementById(`${tabName}ChatBox`);
      if (chatBox) {
        const messageDiv = document.createElement('div');
        if (type === 'user') {
          messageDiv.className = 'message user-message';
        } else if (type === 'error') {
          messageDiv.className = 'error-message';
        } else {
          messageDiv.className = 'message bot-message';
        }
        messageDiv.innerHTML = message.replace(/\n/g, '<br>');
        chatBox.appendChild(messageDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
      }
    }

    function clearChat(tabName) {
      const chatBox = document.getElementById(`${tabName}ChatBox`);
      if (chatBox) {
        chatBox.innerHTML = '';
        conversationHistories[tabName] = [];
        addDebugLog(`Chat cleared for ${tabName} tab`);
      }
    }

    async function exportChat(tabName, format) {
      const history = conversationHistories[tabName];
      if (history.length === 0) {
        alert('No chat history to export');
        return;
      }
      let content = `CureBot ${tabName.charAt(0).toUpperCase() + tabName.slice(1)} Health Chat Export\n`;
      content += `Generated on: ${new Date().toLocaleString()}\n\n`;
      history.forEach((msg, index) => {
        content += `${msg.role.toUpperCase()}: ${msg.content}\n\n`;
      });
      if (format === 'txt') {
        const blob = new Blob([content], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `curebot-${tabName}-chat.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      } else if (format === 'pdf') {
        if (typeof jspdf !== 'undefined') {
          const { jsPDF } = jspdf;
          const doc = new jsPDF();
          doc.setFontSize(10);
          doc.text(content, 10, 10);
          doc.save(`curebot-${tabName}-chat.pdf`);
        } else {
          alert('PDF export not supported. Please include jsPDF library.');
        }
      } else if (format === 'word') {
        alert('Word export not implemented. Please include docx library.');
      }
      addDebugLog(`Chat exported as ${format} for ${tabName}`);
    }

    document.addEventListener('DOMContentLoaded', function() {
      const loadingSpinner = document.getElementById('loadingSpinner');
      setTimeout(() => {
        if (loadingSpinner) {
          loadingSpinner.style.display = 'none';
        }
      }, 500); // Hide spinner after 500ms

      loadConfig(); // Load API key and config immediately
      document.querySelectorAll('.provider-tab').forEach(tab => {
        tab.addEventListener('click', function() {
          currentProvider = this.dataset.provider;
          document.querySelectorAll('.provider-tab').forEach(t => t.classList.remove('active'));
          this.classList.add('active');
          document.getElementById('openrouter-config').style.display = currentProvider === 'openrouter' ? 'block' : 'none';
          document.getElementById('ollama-config').style.display = currentProvider === 'ollama' ? 'block' : 'none';
          updateConnectionStatus('disconnected', 'Not Connected', 'Configure your API settings');
          const modelSelect = document.getElementById('modelSelect');
          if (modelSelect) {
            modelSelect.innerHTML = '<option value="">Configure provider first</option>';
          }
          addDebugLog(`Switched to provider: ${currentProvider}`);
        });
        tab.addEventListener('touchstart', function(e) {
          e.preventDefault();
          this.click();
        });
      });
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', function() {
          const targetTab = this.dataset.tab;
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
          this.classList.add('active');
          const targetContent = document.getElementById(targetTab);
          if (targetContent) {
            targetContent.classList.add('active');
          }
          addDebugLog(`Switched to tab: ${targetTab}`);
        });
        tab.addEventListener('touchstart', function(e) {
          e.preventDefault();
          this.click();
        });
      });
      const testOllamaBtn = document.getElementById('testOllamaBtn');
      if (testOllamaBtn) {
        testOllamaBtn.addEventListener('click', testOllamaConnection);
        testOllamaBtn.addEventListener('touchstart', function(e) {
          e.preventDefault();
          testOllamaConnection();
        });
      }
      const loadModelsBtn = document.getElementById('loadModelsBtn');
      if (loadModelsBtn) {
        loadModelsBtn.addEventListener('click', loadModels);
        loadModelsBtn.addEventListener('touchstart', function(e) {
          e.preventDefault();
          loadModels();
        });
      }
      const saveConfigBtn = document.getElementById('saveConfigBtn');
      if (saveConfigBtn) {
        saveConfigBtn.addEventListener('click', saveConfig);
        saveConfigBtn.addEventListener('touchstart', function(e) {
          e.preventDefault();
          saveConfig();
        });
      }
      const refreshModelsBtn = document.getElementById('refreshModelsBtn');
      if (refreshModelsBtn) {
        refreshModelsBtn.addEventListener('click', loadModels);
        refreshModelsBtn.addEventListener('touchstart', function(e) {
          e.preventDefault();
          loadModels();
        });
      }
      const debugToggleBtn = document.getElementById('debugToggleBtn');
      if (debugToggleBtn) {
        debugToggleBtn.addEventListener('click', function() {
          const debugInfo = document.getElementById('debugInfo');
          if (debugInfo) {
            debugInfo.style.display = debugInfo.style.display === 'block' ? 'none' : 'block';
            addDebugLog(`Debug info ${debugInfo.style.display === 'block' ? 'shown' : 'hidden'}`);
          }
        });
        debugToggleBtn.addEventListener('touchstart', function(e) {
          e.preventDefault();
          this.click();
        });
      }
      tabs.forEach(tab => {
        const input = document.getElementById(`${tab}Input`);
        const sendBtn = document.getElementById(`${tab}Send`);
        const clearBtn = document.getElementById(`clearChatBtn${tab.charAt(0).toUpperCase()}`);
        if (sendBtn && input) {
          sendBtn.addEventListener('click', () => sendMessage(tab, input.value));
          sendBtn.addEventListener('touchstart', function(e) {
            e.preventDefault();
            sendMessage(tab, input.value);
          });
          input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
              e.preventDefault();
              sendMessage(tab, this.value);
            }
          });
        }
        if (clearBtn) {
          clearBtn.addEventListener('click', () => clearChat(tab));
          clearBtn.addEventListener('touchstart', function(e) {
            e.preventDefault();
            clearChat(tab);
          });
        }
        const quickQuestions = document.querySelectorAll(`#${tab} .quick-question`);
        quickQuestions.forEach(question => {
          const handleQuickQuestion = function(e) {
            e.preventDefault();
            if (isStreaming) return;
            question.setAttribute('aria-disabled', 'true');
            question.style.opacity = '0.6';
            if (input) {
              input.value = this.textContent;
              sendMessage(tab, this.textContent).finally(() => {
                question.setAttribute('aria-disabled', 'false');
                question.style.opacity = '1';
              });
            }
          };
          question.addEventListener('click', handleQuickQuestion);
          question.addEventListener('touchstart', handleQuickQuestion);
          question.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              handleQuickQuestion.call(this, e);
            }
          });
        });
        const exportBtn = document.getElementById(`exportBtn${tab.charAt(0).toUpperCase()}`);
        const exportMenu = document.getElementById(`exportMenu${tab.charAt(0).toUpperCase()}`);
        if (exportBtn && exportMenu) {
          exportBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            exportMenu.classList.toggle('show');
          });
          exportBtn.addEventListener('touchstart', function(e) {
            e.preventDefault();
            exportMenu.classList.toggle('show');
          });
          exportMenu.addEventListener('click', function(e) {
            if (e.target.classList.contains('export-option')) {
              const format = e.target.dataset.format;
              exportChat(tab, format);
              exportMenu.classList.remove('show');
            }
          });
          exportMenu.addEventListener('touchstart', function(e) {
            if (e.target.classList.contains('export-option')) {
              e.preventDefault();
              const format = e.target.dataset.format;
              exportChat(tab, format);
              exportMenu.classList.remove('show');
            }
          });
        }
      });
      document.addEventListener('click', function() {
        document.querySelectorAll('.export-menu').forEach(menu => {
          menu.classList.remove('show');
        });
      });
      document.addEventListener('touchstart', function(e) {
        if (!e.target.closest('.export-dropdown')) {
          document.querySelectorAll('.export-menu').forEach(menu => {
            menu.classList.remove('show');
          });
        }
      });
      addDebugLog('CureBot initialized successfully (UA: ' + navigator.userAgent + ')');
    });
  </script>
</body>
</html>
